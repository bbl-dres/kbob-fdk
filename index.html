<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBOB Fachdatenkatalog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Design System CSS -->
    <link rel="stylesheet" href="css/tokens.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Top Bar with Language Selector (CD Bund) -->
    <div class="top-bar">
        <div class="top-bar__container">
            <div class="lang-dropdown" id="langDropdown">
                <button class="lang-dropdown__toggle" aria-expanded="false" aria-haspopup="true">
                    <span id="currentLang">DE</span>
                    <i data-lucide="chevron-down" aria-hidden="true"></i>
                </button>
                <div class="lang-dropdown__menu" role="menu">
                    <button class="lang-dropdown__item active" data-lang="de" role="menuitem">DE</button>
                    <button class="lang-dropdown__item" data-lang="fr" role="menuitem">FR</button>
                    <button class="lang-dropdown__item" data-lang="it" role="menuitem">IT</button>
                    <button class="lang-dropdown__item" data-lang="en" role="menuitem">EN</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="header__top">
            <a href="#home" class="header__branding">
                <!-- Swiss Coat of Arms -->
                <div class="header__logo">
                    <img src="assets/swiss-logo-flag.svg" alt="Schweizerisches Wappen">
                </div>
                <!-- Multilingual Confederation Text -->
                <div class="header__confederation">
                    Schweizerische Eidgenossenschaft<br>
                    Confédération suisse<br>
                    Confederazione Svizzera<br>
                    Confederaziun svizra
                </div>
                <!-- Vertical Separator -->
                <div class="header__separator" aria-hidden="true"></div>
                <!-- Main Title -->
                <div class="header__title">
                    <span>KBOB</span>
                    <span>Fachdatenkatalog</span>
                </div>
            </a>
            <div class="header__controls">
                <div class="header__links">
                    <a href="https://www.kbob.admin.ch/de/kontakt-kbob" class="header__link" target="_blank">Kontakt</a>
                </div>
                <div class="header__search">
                    <button class="header__search-toggle" id="headerSearchToggle" aria-expanded="false" aria-controls="headerSearchForm">
                        <span>Suche</span>
                        <i data-lucide="search" aria-hidden="true"></i>
                    </button>
                    <form class="header__search-form" id="headerSearchForm" role="search" aria-label="Website durchsuchen">
                        <input type="search" id="headerSearchInput" class="header__search-input" placeholder="Suche" autocomplete="off">
                        <button type="button" class="header__search-clear" id="headerSearchClear" aria-label="Suche löschen">
                            <i data-lucide="x" aria-hidden="true"></i>
                        </button>
                        <button type="submit" class="header__search-submit" aria-label="Suchen">
                            <i data-lucide="search" aria-hidden="true"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <nav class="main-nav">
            <div class="container">
                <ul id="main-nav-list">
                    <li><a href="#home" class="nav-link active" data-route="home">Fachdatenkatalog</a></li>
                    <li><a href="#usecases" class="nav-link" data-route="usecases">Anwendungsfälle</a></li>
                    <li><a href="#elements" class="nav-link" data-route="elements">Elemente</a></li>
                    <li><a href="#models" class="nav-link" data-route="models">Fachmodelle</a></li>
                    <li><a href="#documents" class="nav-link" data-route="documents">Dokumente</a></li>
                    <li><a href="#epds" class="nav-link" data-route="epds">Ökobilanzdaten</a></li>
                    <li><a href="#handbook" class="nav-link" data-route="handbook">Handbuch & Downloads</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="breadcrumb-bar" id="breadcrumb-bar">
        <div class="container breadcrumb-bar__inner">
            <nav class="breadcrumb-nav" id="breadcrumb-nav" aria-label="Breadcrumb">
                <a href="#home">Startseite</a>
            </nav>
            <div class="page-toolbar">
                <button class="toolbar-btn" onclick="window.print()" title="Drucken" aria-label="Seite drucken">
                    <i data-lucide="printer" aria-hidden="true"></i>
                </button>
                <button class="toolbar-btn" onclick="shareCurrentPage()" title="Teilen" aria-label="Seite teilen">
                    <i data-lucide="share-2" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>

    <main id="content-area">
         <div class="container loading-state">
            <i data-lucide="refresh-cw" class="loading-spinner" aria-hidden="true"></i><br>
            Anwendung wird initialisiert...
         </div>
    </main>

    <section class="contact-section">
        <div class="container">
            <div class="contact-details">
                <h3>Kontakt</h3>
                <address class="contact-info">
                    Fellerstrasse 21 | CH-3003 Bern | <a href="mailto:kbob@bbl.admin.ch">kbob@bbl.admin.ch</a>
                </address>
                <small class="contact-copyright">
                    © Koordinationskonferenz der Bau- und Liegenschaftsorgane der öffentlichen Bauherren KBOB
                </small>
            </div>
            <button class="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Nach oben" aria-label="Nach oben scrollen">
                <i data-lucide="chevron-up" aria-hidden="true"></i>
            </button>
        </div>
    </section>

    <footer>
        <div class="footer-content">
           <a href="https://github.com/davras5/kbob-fdk" target="_blank">Quellcode</a>
           <a href="#" target="_blank">API</a>
           <a href="https://www.admin.ch/gov/de/start/rechtliches.html" target="_blank">Rechtliches</a>
           <span class="footer-version">Version 1.0.0 | Stand: Dezember 2024</span>
        </div>
    </footer>

    <script>
        const contentArea = document.getElementById('content-area');
        
        // --- STATE ---
        let globalElementsData = [];
        let globalDocumentsData = [];
        let globalUsecasesData = [];
        let globalModelsData = [];
        let globalEpdsData = [];
        let isDataLoaded = false;

        // Filter visibility states (collapsible filter panels)
        let elementsFilterVisible = false;
        let documentsFilterVisible = false;
        let usecasesFilterVisible = false;
        let modelsFilterVisible = false;
        let epdsFilterVisible = false;
        let currentSearchQuery = '';
        let currentSearchSort = 'date-desc';

        // Track which cards have expanded tags (show all tags)
        const expandedCardTags = new Set();

        // ============================================
        // BREADCRUMB FUNCTIONS
        // ============================================

        // Route name mappings for breadcrumbs
        const routeNames = {
            'home': 'Startseite',
            'elements': 'Elemente',
            'element': 'Element',
            'documents': 'Dokumente',
            'document': 'Dokument',
            'usecases': 'Anwendungsfälle',
            'usecase': 'Anwendungsfall',
            'models': 'Fachmodelle',
            'model': 'Fachmodell',
            'epds': 'Ökobilanzdaten',
            'epd': 'Ökobilanzdaten',
            'handbook': 'Handbuch & Downloads',
            'search': 'Suchergebnisse'
        };

        // Get parent route for detail pages
        const parentRoutes = {
            'element': 'elements',
            'document': 'documents',
            'usecase': 'usecases',
            'model': 'models',
            'epd': 'epds'
        };

        /**
         * Update breadcrumb navigation based on current route
         */
        function updateBreadcrumbs(route, id, itemTitle) {
            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            if (!breadcrumbNav) return;

            let breadcrumbs = [];

            // Home is always first
            breadcrumbs.push({ label: 'Startseite', href: '#home' });

            if (route === 'home') {
                // Show Startseite > Fachdatenkatalog for home view
                breadcrumbs = [
                    { label: 'Startseite', href: '#home' },
                    { label: 'Fachdatenkatalog', href: null, current: true }
                ];
            } else if (parentRoutes[route]) {
                // Detail page - show parent category and current item
                const parentRoute = parentRoutes[route];
                breadcrumbs.push({
                    label: routeNames[parentRoute],
                    href: `#${parentRoute}`
                });
                breadcrumbs.push({
                    label: itemTitle || routeNames[route],
                    href: null,
                    current: true
                });
            } else {
                // List/category page
                breadcrumbs.push({
                    label: routeNames[route] || route,
                    href: null,
                    current: true
                });
            }

            // Build HTML with dropdown icons
            const html = breadcrumbs.map((crumb, index) => {
                const separator = index > 0
                    ? '<span class="breadcrumb-separator"><i data-lucide="chevron-right" aria-hidden="true"></i></span>'
                    : '';

                if (crumb.current) {
                    // Current item
                    return `${separator}<span class="breadcrumb-item"><span class="breadcrumb-current">${crumb.label}</span></span>`;
                } else {
                    // Link item
                    return `${separator}<span class="breadcrumb-item"><a href="${crumb.href}">${crumb.label}</a></span>`;
                }
            }).join('');

            breadcrumbNav.innerHTML = html;

            // Re-initialize lucide icons for the chevrons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Share current page using Web Share API or fallback to clipboard
         */
        function shareCurrentPage() {
            const url = window.location.href;
            const title = document.title;

            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).catch(() => {
                    // User cancelled or error
                    copyToClipboard(url);
                });
            } else {
                copyToClipboard(url);
            }
        }

        /**
         * Copy text to clipboard with toast notification
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Link in Zwischenablage kopiert', 'success');
            }).catch(() => {
                showToast('Kopieren fehlgeschlagen', 'error');
            });
        }

        // ============================================
        // URL UTILITY FUNCTIONS
        // ============================================
        
        /**
         * Parse the current hash and extract route, id, and tags
         * @returns {Object} { route: string, id: string|null, tags: string[] }
         */
        function parseHashWithParams() {
            const fullHash = window.location.hash.slice(1) || 'home';
            const [hashPart, queryPart] = fullHash.split('?');
            
            // Parse route and id
            let route = hashPart;
            let id = null;
            
            if (hashPart.startsWith('element/')) {
                route = 'element';
                id = hashPart.split('/')[1];
            } else if (hashPart.startsWith('document/')) {
                route = 'document';
                id = hashPart.split('/')[1];
            } else if (hashPart.startsWith('usecase/')) {
                route = 'usecase';
                id = hashPart.split('/')[1];
            } else if (hashPart.startsWith('model/')) {
                route = 'model';
                id = hashPart.split('/')[1];
            } else if (hashPart.startsWith('epd/')) {
                route = 'epd';
                id = hashPart.split('/')[1];
            }
            
            // Parse query params
            const tags = [];
            const phases = [];
            let searchQuery = '';
            let category = '';
            let view = 'grid'; // Default view
            if (queryPart) {
                const params = new URLSearchParams(queryPart);
                params.getAll('tag').forEach(tag => {
                    if (tag) {
                        tags.push(tag);
                    }
                });
                params.getAll('phase').forEach(phase => {
                    const phaseNum = parseInt(phase, 10);
                    if (!isNaN(phaseNum) && phaseNum >= 1 && phaseNum <= 5) {
                        phases.push(phaseNum);
                    }
                });
                searchQuery = params.get('q') || '';
                category = params.get('category') || '';
                const viewParam = params.get('view');
                if (viewParam === 'list' || viewParam === 'grid') {
                    view = viewParam;
                }
            }

            return { route, id, tags, phases, searchQuery, category, view };
        }

        /**
         * Get active tags from the current URL
         * @returns {string[]} Array of tag strings like ['Architektur', 'IfcWindow']
         */
        function getActiveTagsFromURL() {
            return parseHashWithParams().tags;
        }

        /**
         * Get active category from the current URL
         * @returns {string} Category string or empty string
         */
        function getActiveCategoryFromURL() {
            return parseHashWithParams().category;
        }

        /**
         * Get active view from the current URL
         * @returns {string} View mode ('grid' or 'list'), defaults to 'grid'
         */
        function getActiveViewFromURL() {
            return parseHashWithParams().view;
        }

        /**
         * Build a hash string with tags, category, phases, and view
         * @param {string} baseHash - The base hash without params (e.g., 'catalog', 'element/e1')
         * @param {string[]} tags - Array of tag strings
         * @param {string} category - Optional category string
         * @param {number[]} phases - Optional array of phase numbers (for usecases)
         * @param {string} view - Optional view mode ('grid' or 'list')
         * @returns {string} Complete hash string with params
         */
        function buildHashWithTags(baseHash, tags, category = '', phases = [], view = '') {
            const params = [];
            if (tags && tags.length > 0) {
                tags.forEach(tag => params.push(`tag=${encodeURIComponent(tag)}`));
            }
            if (category) {
                params.push(`category=${encodeURIComponent(category)}`);
            }
            if (phases && phases.length > 0) {
                phases.forEach(phase => params.push(`phase=${phase}`));
            }
            if (view && (view === 'grid' || view === 'list')) {
                params.push(`view=${view}`);
            }
            if (params.length === 0) {
                return baseHash;
            }
            return `${baseHash}?${params.join('&')}`;
        }
        
        /**
         * Toggle a tag in the URL (add if missing, remove if present)
         * @param {string} tag - Tag string (e.g., 'Architektur')
         */
        window.toggleTagInURL = function(tag) {
            const { route, id, tags, category, phases, view } = parseHashWithParams();

            const tagIndex = tags.indexOf(tag);
            if (tagIndex > -1) {
                // Remove tag
                tags.splice(tagIndex, 1);
            } else {
                // Add tag
                tags.push(tag);
            }

            // Build base hash - redirect to list view if on detail page
            let baseHash = route;
            if (id) {
                // On detail page: redirect to corresponding list view
                const routeMap = {
                    'element': 'elements',
                    'document': 'documents',
                    'usecase': 'usecases',
                    'model': 'models',
                    'epd': 'epds'
                };
                baseHash = routeMap[route] || route;
            }

            // Navigate to new URL (preserve category, phases, and view)
            window.location.hash = buildHashWithTags(baseHash, tags, category, phases, view);
        }

        /**
         * Toggle a category in the URL (add if not set, remove if same category)
         * @param {string} cat - Category string (e.g., 'Grundlagen')
         */
        window.toggleCategoryInURL = function(cat) {
            const { route, id, tags, category, phases, view } = parseHashWithParams();

            // Toggle: if same category, remove it; otherwise set the new one
            const newCategory = (category === cat) ? '' : cat;

            // Build base hash - redirect to list view if on detail page
            let baseHash = route;
            if (id) {
                // On detail page: redirect to corresponding list view
                const routeMap = {
                    'element': 'elements',
                    'document': 'documents',
                    'usecase': 'usecases',
                    'model': 'models',
                    'epd': 'epds'
                };
                baseHash = routeMap[route] || route;
            }

            // Navigate to new URL (preserve tags, phases, and view)
            window.location.hash = buildHashWithTags(baseHash, tags, newCategory, phases, view);
        }

        /**
         * Toggle a phase in the URL (add if missing, remove if present)
         * @param {number} phase - Phase number (1-5)
         */
        window.togglePhaseInURL = function(phase) {
            const { route, id, tags, category, phases, view } = parseHashWithParams();
            const phaseNum = parseInt(phase, 10);

            const phaseIndex = phases.indexOf(phaseNum);
            if (phaseIndex > -1) {
                // Remove phase
                phases.splice(phaseIndex, 1);
            } else {
                // Add phase
                phases.push(phaseNum);
            }

            // Build base hash - redirect to list view if on detail page
            let baseHash = route;
            if (id) {
                const routeMap = {
                    'element': 'elements',
                    'document': 'documents',
                    'usecase': 'usecases',
                    'model': 'models',
                    'epd': 'epds'
                };
                baseHash = routeMap[route] || route;
            }

            // Navigate to new URL (preserve view)
            window.location.hash = buildHashWithTags(baseHash, tags, category, phases, view);
        }

        /**
         * Clear all tags from URL
         */
        window.clearAllTagsFromURL = function() {
            const { route, id } = parseHashWithParams();
            let baseHash = route;
            if (id) {
                baseHash = `${route}/${id}`;
            }
            window.location.hash = baseHash;
        }

        /**
         * Clear all filters (wrapper for toolbar reset button)
         */
        window.clearAllFilters = function(type) {
            clearAllTagsFromURL();
        }

        /**
         * Navigate to a route while preserving current tags, category, phases, and view
         * @param {string} targetRoute - Target route (e.g., 'catalog', 'documents')
         */
        function navigateWithTags(targetRoute) {
            const tags = getActiveTagsFromURL();
            const category = getActiveCategoryFromURL();
            const phases = getActivePhasesFromURL();
            const view = getActiveViewFromURL();
            window.location.hash = buildHashWithTags(targetRoute, tags, category, phases, view);
        }

        /**
         * Filter data by active tags (AND logic - must match all tags)
         * @param {Array} data - Array of data items
         * @param {string[]} activeTags - Array of tag strings
         * @returns {Array} Filtered data
         */
        function filterDataByTags(data, activeTags) {
            if (!activeTags || activeTags.length === 0) {
                return data;
            }

            return data.filter(item => {
                if (!item.tags || !Array.isArray(item.tags)) return false;

                return activeTags.every(tag => item.tags.includes(tag));
            });
        }

        /**
         * Filter data by active category
         * @param {Array} data - Array of data items
         * @param {string} activeCategory - Category string
         * @returns {Array} Filtered data
         */
        function filterDataByCategory(data, activeCategory) {
            if (!activeCategory) {
                return data;
            }

            return data.filter(item => item.category === activeCategory);
        }

        /**
         * Check if a specific tag is active
         * @param {string} tag - Tag string
         * @returns {boolean}
         */
        function isTagActive(tag) {
            const activeTags = getActiveTagsFromURL();
            return activeTags.includes(tag);
        }

        // --- FILTER DATA EXTRACTION HELPERS ---

        /**
         * Extract unique categories from data array
         * @param {Array} data - Array of data items
         * @returns {string[]} Sorted array of unique categories
         */
        function getUniqueCategories(data) {
            if (!data || !Array.isArray(data)) return [];
            const categories = new Set();
            data.forEach(item => {
                if (item.category) {
                    categories.add(item.category);
                }
            });
            return Array.from(categories).sort();
        }

        /**
         * Extract unique tags from data array
         * @param {Array} data - Array of data items
         * @returns {string[]} Sorted array of unique tags
         */
        function getUniqueTags(data) {
            if (!data || !Array.isArray(data)) return [];
            const tags = new Set();
            data.forEach(item => {
                if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach(tag => tags.add(tag));
                }
            });
            return Array.from(tags).sort();
        }

        /**
         * Get phase labels for display
         */
        const phaseLabels = {
            1: 'Entwicklung',
            2: 'Planung',
            3: 'Ausführung',
            4: 'Betrieb',
            5: 'Rückbau'
        };

        /**
         * Filter data by active phases (OR logic - item must include at least one selected phase)
         * @param {Array} data - Array of data items
         * @param {number[]} activePhases - Array of phase numbers
         * @returns {Array} Filtered data
         */
        function filterDataByPhases(data, activePhases) {
            if (!activePhases || activePhases.length === 0) {
                return data;
            }
            return data.filter(item => {
                if (!item.phases || !Array.isArray(item.phases)) return false;
                return activePhases.some(phase => item.phases.includes(phase));
            });
        }

        /**
         * Get active phases from the current URL
         * @returns {number[]} Array of phase numbers
         */
        function getActivePhasesFromURL() {
            return parseHashWithParams().phases || [];
        }

        // --- INITIALIZATION ---
        async function initApp() {
            try {
                // Load all data
                const [elementsResponse, documentsResponse, usecasesResponse, modelsResponse, epdsResponse] = await Promise.all([
                    fetch('data/elements.json'),
                    fetch('data/documents.json'),
                    fetch('data/usecases.json'),
                    fetch('data/models.json'),
                    fetch('data/epds.json')
                ]);

                if (!elementsResponse.ok) throw new Error(`Elements: HTTP error! status: ${elementsResponse.status}`);
                if (!documentsResponse.ok) throw new Error(`Documents: HTTP error! status: ${documentsResponse.status}`);
                if (!usecasesResponse.ok) throw new Error(`Usecases: HTTP error! status: ${usecasesResponse.status}`);
                if (!modelsResponse.ok) throw new Error(`Models: HTTP error! status: ${modelsResponse.status}`);
                if (!epdsResponse.ok) throw new Error(`EPDs: HTTP error! status: ${epdsResponse.status}`);

                globalElementsData = await elementsResponse.json();
                globalDocumentsData = await documentsResponse.json();
                globalUsecasesData = await usecasesResponse.json();
                globalModelsData = await modelsResponse.json();
                globalEpdsData = await epdsResponse.json();

                isDataLoaded = true;

                // Setup nav link click handlers for tag preservation
                setupNavLinks();

                // Setup header search toggle and form
                setupHeaderSearch();

                window.addEventListener('hashchange', router);
                router();
            } catch (error) {
                console.error("Fehler beim Laden der Daten:", error);
                contentArea.innerHTML = `
                    <div class="container error-state">
                        <i data-lucide="alert-circle" class="status-icon status-icon--error icon--3xl" aria-hidden="true"></i><br>
                        <h2>Fehler beim Laden der Daten</h2>
                        <p>Konnte JSON-Dateien nicht laden.</p>
                        <br><span class="error-detail">${error.message}</span>
                    </div>`;
                lucide.createIcons();
            }
        }
        
        /**
         * Setup nav links to preserve tags when switching tabs
         */
        function setupNavLinks() {
            document.querySelectorAll('.main-nav .nav-link:not(.disabled)').forEach(link => {
                link.addEventListener('click', (e) => {
                    const route = link.getAttribute('data-route');
                    if (route) {
                        e.preventDefault();
                        navigateWithTags(route);
                    }
                });
            });
        }

        // --- ROUTER ---
        function router() {
            if (!isDataLoaded) return;

            // Scroll to top when navigating to a new page
            window.scrollTo(0, 0);

            const { route, id, tags, searchQuery, category } = parseHashWithParams();

            // Update nav active states
            document.querySelectorAll('.main-nav .nav-link:not(.disabled)').forEach(link => {
                const linkRoute = link.getAttribute('data-route');
                let isActive = false;
                if (route === 'element') {
                    isActive = (linkRoute === 'elements');
                } else if (route === 'document') {
                    isActive = (linkRoute === 'documents');
                } else if (route === 'usecase') {
                    isActive = (linkRoute === 'usecases');
                } else if (route === 'model') {
                    isActive = (linkRoute === 'models');
                } else if (route === 'epd') {
                    isActive = (linkRoute === 'epds');
                } else {
                    isActive = (linkRoute === route);
                }
                link.classList.toggle('active', isActive);
            });

            // Update breadcrumbs
            let itemTitle = null;
            if (id) {
                // Get item title for detail pages
                if (route === 'element') {
                    const item = globalElementsData.find(e => e.id === id);
                    itemTitle = item ? item.title : null;
                } else if (route === 'document') {
                    const item = globalDocumentsData.find(d => d.id === id);
                    itemTitle = item ? item.title : null;
                } else if (route === 'usecase') {
                    const item = globalUsecasesData.find(u => u.id === id);
                    itemTitle = item ? item.title : null;
                } else if (route === 'model') {
                    const item = globalModelsData.find(m => m.id === id);
                    itemTitle = item ? item.title : null;
                } else if (route === 'epd') {
                    const item = globalEpdsData.find(e => e.id === id);
                    itemTitle = item ? item.title : null;
                }
            }
            updateBreadcrumbs(route, id, itemTitle);

            contentArea.classList.remove('white-bg');

            switch(route) {
                case 'home': renderHomePage(); break;
                case 'search': renderSearchResultsPage(searchQuery); break;
                case 'elements': renderCatalogPage(tags, category); break;
                case 'documents': renderDocumentsCatalogPage(tags, category); break;
                case 'usecases': renderUsecasesCatalogPage(tags, category); break;
                case 'models': renderModelsCatalogPage(tags, category); break;
                case 'epds': renderEpdsCatalogPage(tags, category); break;
                case 'handbook': renderHandbookPage(); break;
                case 'element':
                    if(id) {
                        contentArea.classList.add('white-bg');
                        renderElementDetailPage(id, tags);
                    } else {
                        navigateWithTags('elements');
                    }
                    break;
                case 'document':
                    if(id) {
                        contentArea.classList.add('white-bg');
                        renderDocumentDetailPage(id, tags, category);
                    } else {
                        navigateWithTags('documents');
                    }
                    break;
                case 'usecase':
                    if(id) {
                        contentArea.classList.add('white-bg');
                        renderUsecaseDetailPage(id, tags, category);
                    } else {
                        navigateWithTags('usecases');
                    }
                    break;
                case 'model':
                    if(id) {
                        contentArea.classList.add('white-bg');
                        renderModelDetailPage(id, tags, category);
                    } else {
                        navigateWithTags('models');
                    }
                    break;
                case 'epd':
                    if(id) {
                        contentArea.classList.add('white-bg');
                        renderEpdDetailPage(id, tags, category);
                    } else {
                        navigateWithTags('epds');
                    }
                    break;
                default: navigateWithTags('home');
            }

            // Initialize Lucide icons after rendering
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- VIEW CONTROLS ---
        window.switchView = function(view) {
            // Update URL with new view parameter - this triggers the router to re-render
            const { route, tags, category, phases } = parseHashWithParams();
            window.location.hash = buildHashWithTags(route, tags, category, phases, view);
        }

        window.toggleFilter = function(type = 'elements') {
            if (type === 'elements') {
                elementsFilterVisible = !elementsFilterVisible;
                renderCatalogPage(getActiveTagsFromURL(), getActiveCategoryFromURL());
            } else if (type === 'documents') {
                documentsFilterVisible = !documentsFilterVisible;
                renderDocumentsCatalogPage(getActiveTagsFromURL(), getActiveCategoryFromURL());
            } else if (type === 'usecases') {
                usecasesFilterVisible = !usecasesFilterVisible;
                renderUsecasesCatalogPage(getActiveTagsFromURL(), getActiveCategoryFromURL());
            } else if (type === 'models') {
                modelsFilterVisible = !modelsFilterVisible;
                renderModelsCatalogPage(getActiveTagsFromURL(), getActiveCategoryFromURL());
            } else if (type === 'epds') {
                epdsFilterVisible = !epdsFilterVisible;
                renderEpdsCatalogPage(getActiveTagsFromURL(), getActiveCategoryFromURL());
            }
        }

        // --- RENDER HELPERS ---
        function renderTagsHtml(tagsData, activeTags = []) {
            if (!tagsData || !Array.isArray(tagsData)) return '';
            return tagsData.map(tag => {
                const isActive = activeTags.includes(tag);
                const activeClass = isActive ? 'active' : '';
                return `<span class="tag-badge ${activeClass}" onclick="event.stopPropagation(); toggleTagInURL('${tag}')" title="Filter: ${tag}">${tag}</span>`;
            }).join('');
        }

        /**
         * Toggle card tags expanded state and re-render the tags container
         */
        window.toggleCardTags = function(cardId) {
            event.stopPropagation();
            if (expandedCardTags.has(cardId)) {
                expandedCardTags.delete(cardId);
            } else {
                expandedCardTags.add(cardId);
            }
            // Re-render just the tags container for this card
            const tagsContainer = document.querySelector(`[data-card-id="${cardId}"] .card__tags`);
            if (tagsContainer) {
                const tagsData = JSON.parse(tagsContainer.dataset.tags || '[]');
                const activeTags = getActiveTagsFromURL();
                tagsContainer.innerHTML = renderCardTagsHtml(cardId, tagsData, activeTags);
            }
        };

        /**
         * Render tags for card with +N / - toggle (max 2 visible by default)
         */
        function renderCardTagsHtml(cardId, tagsData, activeTags = []) {
            if (!tagsData || !Array.isArray(tagsData) || tagsData.length === 0) return '';

            const maxVisible = 2;
            const isExpanded = expandedCardTags.has(cardId);
            const hiddenCount = tagsData.length - maxVisible;

            // If 2 or fewer tags, or expanded, show all tags
            if (tagsData.length <= maxVisible || isExpanded) {
                const tagsHtml = tagsData.map(tag => {
                    const isActive = activeTags.includes(tag);
                    const activeClass = isActive ? 'active' : '';
                    return `<span class="tag-badge ${activeClass}" onclick="event.stopPropagation(); toggleTagInURL('${tag}')" title="Filter: ${tag}">${tag}</span>`;
                }).join('');

                // Add collapse button if expanded and has more than maxVisible
                if (isExpanded && tagsData.length > maxVisible) {
                    return tagsHtml + `<span class="tag-badge tag-badge--count" onclick="toggleCardTags('${cardId}')" title="Weniger anzeigen">−</span>`;
                }
                return tagsHtml;
            }

            // Show limited tags with +N button
            const visibleTags = tagsData.slice(0, maxVisible);
            const tagsHtml = visibleTags.map(tag => {
                const isActive = activeTags.includes(tag);
                const activeClass = isActive ? 'active' : '';
                return `<span class="tag-badge ${activeClass}" onclick="event.stopPropagation(); toggleTagInURL('${tag}')" title="Filter: ${tag}">${tag}</span>`;
            }).join('');

            return tagsHtml + `<span class="tag-badge tag-badge--count" onclick="toggleCardTags('${cardId}')" title="${hiddenCount} weitere Tags anzeigen">+${hiddenCount}</span>`;
        }
        
        /**
         * Render filter bar header with optional reset icon
         */
        function renderFilterBarHeader(activeTags, activeCategory = '') {
            const hasFilters = activeTags.length > 0 || activeCategory;
            const resetBtn = hasFilters
                ? `<button class="filter-bar__reset" onclick="clearAllFilters()" title="Filter zurücksetzen" aria-label="Filter zurücksetzen"><i data-lucide="x" aria-hidden="true"></i></button>`
                : '';

            // Build active filters display
            let activeFiltersHtml = '';
            if (hasFilters) {
                const filterBadges = [];
                if (activeCategory) {
                    filterBadges.push(`<span class="tag-badge active" onclick="toggleCategoryInURL('${activeCategory}')">${activeCategory} <i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;"></i></span>`);
                }
                activeTags.forEach(tag => {
                    filterBadges.push(`<span class="tag-badge active" onclick="toggleTagInURL('${tag}')">${tag} <i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;"></i></span>`);
                });
                activeFiltersHtml = `<div class="filter-bar__active-filters" style="display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-top:var(--space-sm);">${filterBadges.join('')}</div>`;
            }

            return `<div class="filter-bar__header"><span>Filter</span>${resetBtn}</div>${activeFiltersHtml}`;
        }

        /**
         * Toggle filter dropdown open/closed
         * @param {string} groupId - The filter group identifier
         */
        window.toggleFilterDropdown = function(groupId) {
            event.stopPropagation();
            const allGroups = document.querySelectorAll('.filter-group');
            allGroups.forEach(group => {
                if (group.dataset.filterId === groupId) {
                    group.classList.toggle('open');
                } else {
                    group.classList.remove('open');
                }
            });
        }

        /**
         * Close all filter dropdowns when clicking outside
         */
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-group')) {
                document.querySelectorAll('.filter-group.open').forEach(group => {
                    group.classList.remove('open');
                });
            }
        });

        /**
         * Render complete filter bar with category and tags dropdowns
         * @param {Object} options - Configuration options
         * @param {Array} options.data - The data array to extract filters from
         * @param {string[]} options.activeTags - Currently active tags
         * @param {string} options.activeCategory - Currently active category
         * @param {number[]} options.activePhases - Currently active phases (for usecases)
         * @param {boolean} options.showPhases - Whether to show phases filter
         * @param {string} options.filterPanelClass - CSS class for visibility
         * @returns {string} HTML string for the filter bar
         */
        function renderFilterBar(options) {
            const {
                data = [],
                activeTags = [],
                activeCategory = '',
                activePhases = [],
                showPhases = false,
                filterPanelClass = ''
            } = options;

            // Extract unique categories and tags from data
            const categories = getUniqueCategories(data);
            const tags = getUniqueTags(data);

            // Count items per category
            const categoryCounts = {};
            categories.forEach(cat => {
                categoryCounts[cat] = data.filter(item => item.category === cat).length;
            });

            // Count items per tag
            const tagCounts = {};
            tags.forEach(tag => {
                tagCounts[tag] = data.filter(item => item.tags && item.tags.includes(tag)).length;
            });

            // Render category dropdown items
            const categoryItemsHtml = categories.map(cat => {
                const isActive = activeCategory === cat;
                const count = categoryCounts[cat];
                return `<span class="filter-dropdown__item ${isActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${cat}')">${cat} <span class="filter-dropdown__count">${count}</span></span>`;
            }).join('');

            // Render tag dropdown items
            const tagItemsHtml = tags.map(tag => {
                const isActive = activeTags.includes(tag);
                const count = tagCounts[tag];
                return `<span class="filter-dropdown__item ${isActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleTagInURL('${tag}')">${tag} <span class="filter-dropdown__count">${count}</span></span>`;
            }).join('');

            // Render phases dropdown if needed
            let phasesGroupHtml = '';
            if (showPhases) {
                // Derive phases from phaseLabels object to avoid hardcoding
                const availablePhases = Object.keys(phaseLabels).map(Number).sort((a, b) => a - b);
                const phasesItemsHtml = availablePhases.map(phase => {
                    const isActive = activePhases.includes(phase);
                    const label = phaseLabels[phase];
                    return `
                        <div class="filter-dropdown__phase-item ${isActive ? 'active' : ''}" onclick="event.stopPropagation(); togglePhaseInURL(${phase})">
                            <span class="filter-dropdown__phase-number">${phase}</span>
                            <span class="filter-dropdown__phase-label">${label}</span>
                        </div>
                    `;
                }).join('');

                const activePhasesCount = activePhases.length;
                phasesGroupHtml = `
                    <div class="filter-group" data-filter-id="phases">
                        <div class="filter-toggle" onclick="toggleFilterDropdown('phases')">
                            Phase ${activePhasesCount > 0 ? `<span class="filter-count-badge" style="background:var(--color-primary);color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:4px;">${activePhasesCount}</span>` : ''}
                            <i data-lucide="chevron-down" aria-hidden="true"></i>
                        </div>
                        <div class="filter-dropdown">
                            <div class="filter-dropdown__title">Phasen</div>
                            <div class="filter-dropdown__phases">
                                ${phasesItemsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Calculate total active filter count
            const hasFilters = activeTags.length > 0 || activeCategory || activePhases.length > 0;
            const resetBtn = hasFilters
                ? `<button class="filter-bar__reset" onclick="clearAllFilters()" title="Filter zurücksetzen" aria-label="Filter zurücksetzen"><i data-lucide="x" aria-hidden="true"></i></button>`
                : '';

            // Build active filters display
            let activeFiltersHtml = '';
            if (hasFilters) {
                const filterBadges = [];
                if (activeCategory) {
                    filterBadges.push(`<span class="tag-badge active" onclick="toggleCategoryInURL('${activeCategory}')">${activeCategory} <i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;"></i></span>`);
                }
                activeTags.forEach(tag => {
                    filterBadges.push(`<span class="tag-badge active" onclick="toggleTagInURL('${tag}')">${tag} <i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;"></i></span>`);
                });
                activePhases.forEach(phase => {
                    filterBadges.push(`<span class="tag-badge active" onclick="togglePhaseInURL(${phase})">Phase ${phase} <i data-lucide="x" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;"></i></span>`);
                });
                activeFiltersHtml = `<div class="filter-bar__active-filters" style="display:flex;gap:var(--space-sm);flex-wrap:wrap;padding:var(--space-sm) var(--space-lg);border-top:1px solid var(--color-border-light);">${filterBadges.join('')}</div>`;
            }

            // Count badges for category and tags
            const activeCategoryCount = activeCategory ? 1 : 0;
            const activeTagsCount = activeTags.length;

            return `
                <div class="filter-bar ${filterPanelClass}">
                    <div class="filter-bar__header"><span>Filter</span>${resetBtn}</div>
                    <div class="filter-bar__groups">
                        <div class="filter-group" data-filter-id="category">
                            <div class="filter-toggle" onclick="toggleFilterDropdown('category')">
                                Kategorie ${activeCategoryCount > 0 ? `<span class="filter-count-badge" style="background:var(--color-primary);color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:4px;">${activeCategoryCount}</span>` : ''}
                                <i data-lucide="chevron-down" aria-hidden="true"></i>
                            </div>
                            <div class="filter-dropdown">
                                <div class="filter-dropdown__title">Kategorie wählen</div>
                                <div class="filter-dropdown__items">
                                    ${categoryItemsHtml}
                                </div>
                            </div>
                        </div>
                        <div class="filter-group" data-filter-id="tags">
                            <div class="filter-toggle" onclick="toggleFilterDropdown('tags')">
                                Tags ${activeTagsCount > 0 ? `<span class="filter-count-badge" style="background:var(--color-primary);color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:4px;">${activeTagsCount}</span>` : ''}
                                <i data-lucide="chevron-down" aria-hidden="true"></i>
                            </div>
                            <div class="filter-dropdown">
                                <div class="filter-dropdown__title">Tags wählen</div>
                                <div class="filter-dropdown__items">
                                    ${tagItemsHtml}
                                </div>
                            </div>
                        </div>
                        ${phasesGroupHtml}
                    </div>
                    ${activeFiltersHtml}
                </div>
            `;
        }

        /**
         * Render filter button with reset button (visible when filters active)
         */
        function renderFilterButton(type, isVisible, activeTagCount) {
            const activeClass = isVisible ? 'active' : '';

            const resetBtn = activeTagCount > 0
                ? `<button class="reset-filter-btn" onclick="clearAllFilters('${type}')" title="Filter zurücksetzen"><i data-lucide="refresh-cw" aria-hidden="true"></i> Zurücksetzen</button>`
                : '';

            return `
                <button class="filter-btn ${activeClass}" onclick="toggleFilter('${type}')">
                    <i data-lucide="filter" aria-hidden="true"></i>
                    Filter${activeTagCount > 0 ? `<span class="filter-count-badge">${activeTagCount}</span>` : ''}
                </button>
                ${resetBtn}
            `;
        }
        
        /**
         * Render no results message with clear filter option
         */
        function renderNoResults(hasActiveTags) {
            if (hasActiveTags) {
                return `
                    <div class="no-results">
                        <h3>Keine Ergebnisse gefunden</h3>
                        <p>Die aktiven Filter ergeben keine Treffer.</p>
                        <p><span class="clear-filter-link" onclick="clearAllTagsFromURL()">Filter zurücksetzen</span></p>
                    </div>
                `;
            }
            return '<div class="no-results">Keine Elemente gefunden.</div>';
        }

        // Arrow SVG for Swiss CD style cards
        const arrowSvg = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        // Elements Grid/List Renderers
        function renderGridItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            return items.map(el => {
                const hasTags = el.tags && Array.isArray(el.tags) && el.tags.length > 0;
                const cardId = `element-${el.id}`;
                const isCategoryActive = activeCategory === el.category;

                return `
                <article class="card" data-card-id="${cardId}" onclick="window.location.hash='${buildHashWithTags('element/' + el.id, activeTags, activeCategory)}'">
                    <div class="card__image">
                        ${el.category ? `<span class="tag-badge ${isCategoryActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${el.category}')">${el.category}</span>` : ''}
                        ${el.image ? `<img src="${el.image}" alt="${el.title}">` : '<i data-lucide="image" class="placeholder-icon icon--xl" aria-hidden="true"></i>'}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">${el.title}</h3>
                        <p class="card__subtitle">${el.description || el.classification}</p>
                        ${hasTags ? `<div class="card__tags" data-tags='${JSON.stringify(el.tags)}'>${renderCardTagsHtml(cardId, el.tags, activeTags)}</div>` : ''}
                    </div>
                    <footer class="card__footer card__footer--end">
                        <span class="card__arrow-btn" aria-label="Details anzeigen">${arrowSvg}</span>
                    </footer>
                </article>
            `}).join('');
        }

        function renderListItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            const headerHtml = `
                <div class="list-header-row">
                    <div class="list-col-name">Name</div>
                    <div class="list-col-desc">Beschreibung</div>
                    <div class="list-col-tags">Tags</div>
                </div>
            `;

            const itemsHtml = items.map(el => {
                const isCategoryActive = activeCategory === el.category;
                return `
                <div class="element-list-item" onclick="window.location.hash='${buildHashWithTags('element/' + el.id, activeTags, activeCategory)}'">
                    <div class="list-col-name">
                        ${el.title}
                    </div>
                    <div class="list-col-desc">${el.description || el.classification}</div>
                    <div class="list-col-tags">${renderTagsHtml(el.tags, activeTags)}</div>
                </div>
            `}).join('');

            return `<div class="element-list-container">${headerHtml}${itemsHtml}</div>`;
        }

        // Documents Grid/List Renderers
        function renderDocGridItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            return items.map(doc => {
                const hasTags = doc.tags && Array.isArray(doc.tags) && doc.tags.length > 0;
                const cardId = `document-${doc.id}`;
                const isCategoryActive = activeCategory === doc.category;

                return `
                <article class="card" data-card-id="${cardId}" onclick="window.location.hash='${buildHashWithTags('document/' + doc.id, activeTags, activeCategory)}'">
                    <div class="card__image">
                        ${doc.category ? `<span class="tag-badge ${isCategoryActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${doc.category}')">${doc.category}</span>` : ''}
                        ${doc.image ? `<img src="${doc.image}" alt="${doc.title}">` : '<i data-lucide="file-text" class="placeholder-icon icon--xl" aria-hidden="true"></i>'}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">${doc.title}</h3>
                        <p class="card__subtitle">${doc.description || doc.category}</p>
                        ${hasTags ? `<div class="card__tags" data-tags='${JSON.stringify(doc.tags)}'>${renderCardTagsHtml(cardId, doc.tags, activeTags)}</div>` : ''}
                    </div>
                    <footer class="card__footer card__footer--end">
                        <span class="card__arrow-btn" aria-label="Details anzeigen">${arrowSvg}</span>
                    </footer>
                </article>
            `}).join('');
        }

        function renderDocListItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            const headerHtml = `
                <div class="list-header-row">
                    <div class="list-col-name">Name</div>
                    <div class="list-col-desc">Beschreibung</div>
                    <div class="list-col-tags">Tags</div>
                </div>
            `;

            const itemsHtml = items.map(doc => {
                const isCategoryActive = activeCategory === doc.category;
                return `
                <div class="element-list-item" onclick="window.location.hash='${buildHashWithTags('document/' + doc.id, activeTags, activeCategory)}'">
                    <div class="list-col-name">
                        ${doc.title}
                    </div>
                    <div class="list-col-desc">${doc.description || doc.category}</div>
                    <div class="list-col-tags">${renderTagsHtml(doc.tags, activeTags)}</div>
                </div>
            `}).join('');

            return `<div class="element-list-container">${headerHtml}${itemsHtml}</div>`;
        }

        // Usecases Grid/List Renderers
        function renderUsecasesGridItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            return items.map(item => {
                const hasTags = item.tags && Array.isArray(item.tags) && item.tags.length > 0;
                const cardId = `usecase-${item.id}`;
                const isCategoryActive = activeCategory === item.category;

                return `
                <article class="card" data-card-id="${cardId}" onclick="window.location.hash='${buildHashWithTags('usecase/' + item.id, activeTags, activeCategory)}'">
                    <div class="card__image">
                        ${item.category ? `<span class="tag-badge ${isCategoryActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${item.category}')">${item.category}</span>` : ''}
                        ${item.image ? `<img src="${item.image}" alt="${item.title}">` : '<i data-lucide="workflow" class="placeholder-icon icon--xl" aria-hidden="true"></i>'}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">${item.title}</h3>
                        <p class="card__subtitle">${item.description || item.category}</p>
                        ${hasTags ? `<div class="card__tags" data-tags='${JSON.stringify(item.tags)}'>${renderCardTagsHtml(cardId, item.tags, activeTags)}</div>` : ''}
                    </div>
                    <footer class="card__footer card__footer--end">
                        <span class="card__arrow-btn" aria-label="Details anzeigen">${arrowSvg}</span>
                    </footer>
                </article>
            `}).join('');
        }

        function renderUsecasesListItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            const headerHtml = `
                <div class="list-header-row">
                    <div class="list-col-name">Name</div>
                    <div class="list-col-desc">Beschreibung</div>
                    <div class="list-col-tags">Tags</div>
                </div>
            `;

            const itemsHtml = items.map(item => {
                const isCategoryActive = activeCategory === item.category;
                return `
                <div class="element-list-item" onclick="window.location.hash='${buildHashWithTags('usecase/' + item.id, activeTags, activeCategory)}'">
                    <div class="list-col-name">
                        ${item.title}
                    </div>
                    <div class="list-col-desc">${item.description || item.category}</div>
                    <div class="list-col-tags">${renderTagsHtml(item.tags, activeTags)}</div>
                </div>
            `}).join('');

            return `<div class="element-list-container">${headerHtml}${itemsHtml}</div>`;
        }

        // Models Grid/List Renderers
        function renderModelsGridItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            return items.map(item => {
                const hasTags = item.tags && Array.isArray(item.tags) && item.tags.length > 0;
                const cardId = `model-${item.id}`;
                const isCategoryActive = activeCategory === item.category;

                return `
                <article class="card" data-card-id="${cardId}" onclick="window.location.hash='${buildHashWithTags('model/' + item.id, activeTags, activeCategory)}'">
                    <div class="card__image">
                        ${item.category ? `<span class="tag-badge ${isCategoryActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${item.category}')">${item.category}</span>` : ''}
                        ${item.image ? `<img src="${item.image}" alt="${item.title}">` : '<i data-lucide="boxes" class="placeholder-icon icon--xl" aria-hidden="true"></i>'}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">${item.title}</h3>
                        <p class="card__subtitle">${item.description || item.category}</p>
                        ${hasTags ? `<div class="card__tags" data-tags='${JSON.stringify(item.tags)}'>${renderCardTagsHtml(cardId, item.tags, activeTags)}</div>` : ''}
                    </div>
                    <footer class="card__footer card__footer--end">
                        <span class="card__arrow-btn" aria-label="Details anzeigen">${arrowSvg}</span>
                    </footer>
                </article>
            `}).join('');
        }

        function renderModelsListItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            const headerHtml = `
                <div class="list-header-row">
                    <div class="list-col-name">Name</div>
                    <div class="list-col-desc">Beschreibung</div>
                    <div class="list-col-tags">Tags</div>
                </div>
            `;

            const itemsHtml = items.map(item => {
                const isCategoryActive = activeCategory === item.category;
                return `
                <div class="element-list-item" onclick="window.location.hash='${buildHashWithTags('model/' + item.id, activeTags, activeCategory)}'">
                    <div class="list-col-name">
                        ${item.title}
                    </div>
                    <div class="list-col-desc">${item.description || item.category}</div>
                    <div class="list-col-tags">${renderTagsHtml(item.tags, activeTags)}</div>
                </div>
            `}).join('');

            return `<div class="element-list-container">${headerHtml}${itemsHtml}</div>`;
        }

        // EPDs Grid/List Renderers
        function renderEpdsGridItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            return items.map(item => {
                const hasTags = item.tags && Array.isArray(item.tags) && item.tags.length > 0;
                const cardId = `epd-${item.id}`;
                const isCategoryActive = activeCategory === item.category;

                return `
                <article class="card" data-card-id="${cardId}" onclick="window.location.hash='${buildHashWithTags('epd/' + item.id, activeTags, activeCategory)}'">
                    <div class="card__image">
                        ${item.category ? `<span class="tag-badge ${isCategoryActive ? 'active' : ''}" onclick="event.stopPropagation(); toggleCategoryInURL('${item.category}')">${item.category}</span>` : ''}
                        ${item.image ? `<img src="${item.image}" alt="${item.title}">` : '<i data-lucide="leaf" class="placeholder-icon icon--xl" aria-hidden="true"></i>'}
                    </div>
                    <div class="card__body">
                        <h3 class="card__title">${item.title}</h3>
                        <p class="card__subtitle">${item.description || item.category}</p>
                        ${hasTags ? `<div class="card__tags" data-tags='${JSON.stringify(item.tags)}'>${renderCardTagsHtml(cardId, item.tags, activeTags)}</div>` : ''}
                    </div>
                    <footer class="card__footer card__footer--end">
                        <span class="card__arrow-btn" aria-label="Details anzeigen">${arrowSvg}</span>
                    </footer>
                </article>
            `}).join('');
        }

        function renderEpdsListItemsHTML(items, activeTags = [], activeCategory = '') {
            if (!items || items.length === 0) return renderNoResults(activeTags.length > 0 || activeCategory);

            const headerHtml = `
                <div class="list-header-row">
                    <div class="list-col-name">Name</div>
                    <div class="list-col-desc">Beschreibung</div>
                    <div class="list-col-tags">Tags</div>
                </div>
            `;

            const itemsHtml = items.map(item => {
                const isCategoryActive = activeCategory === item.category;
                return `
                <div class="element-list-item" onclick="window.location.hash='${buildHashWithTags('epd/' + item.id, activeTags, activeCategory)}'">
                    <div class="list-col-name">
                        ${item.title}
                    </div>
                    <div class="list-col-desc">${item.description || item.category}</div>
                    <div class="list-col-tags">${renderTagsHtml(item.tags, activeTags)}</div>
                </div>
            `}).join('');

            return `<div class="element-list-container">${headerHtml}${itemsHtml}</div>`;
        }

        function renderPhaseBadges(phases) {
            if(!phases || !Array.isArray(phases)) return '<span class="empty-text">-</span>';
            // Derive phases from phaseLabels object to avoid hardcoding
            const allPhases = Object.keys(phaseLabels).map(Number).sort((a, b) => a - b);
            let badgesHtml = '<div class="phase-compact-wrapper">';
            allPhases.forEach(phase => {
                const statusClass = phases.includes(phase) ? 'active' : 'inactive';
                badgesHtml += `<div class="phase-badge ${statusClass}" title="${phaseLabels[phase] || 'Phase ' + phase}">${phase}</div>`;
            });
            badgesHtml += '</div>';
            return badgesHtml;
        }

        // --- GLOBAL SEARCH (Homepage) ---
        function performGlobalSearch(query) {
            const results = {
                anwendungsfaelle: [],
                elemente: [],
                fachmodelle: [],
                dokumente: [],
                oekobilanzdaten: []
            };

            const searchTerm = query.toLowerCase().trim();
            if (searchTerm.length < 2) return results;

            // Search Elements
            results.elemente = globalElementsData
                .filter(el =>
                    (el.title && el.title.toLowerCase().includes(searchTerm)) ||
                    (el.classification && el.classification.toLowerCase().includes(searchTerm)) ||
                    (el.description && el.description.toLowerCase().includes(searchTerm))
                )
                .slice(0, 3);

            // Search Documents
            results.dokumente = globalDocumentsData
                .filter(doc =>
                    (doc.title && doc.title.toLowerCase().includes(searchTerm)) ||
                    (doc.category && doc.category.toLowerCase().includes(searchTerm)) ||
                    (doc.description && doc.description.toLowerCase().includes(searchTerm))
                )
                .slice(0, 3);

            // Search Usecases
            results.anwendungsfaelle = globalUsecasesData
                .filter(item =>
                    (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
                .slice(0, 3);

            // Search Models
            results.fachmodelle = globalModelsData
                .filter(item =>
                    (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
                .slice(0, 3);

            // Search EPDs
            results.oekobilanzdaten = globalEpdsData
                .filter(item =>
                    (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
                .slice(0, 3);

            return results;
        }

        function renderSearchDropdown(results, query) {
            const categories = [
                { key: 'anwendungsfaelle', label: 'Anwendungsfälle', hashPrefix: 'usecase' },
                { key: 'elemente', label: 'Elemente', hashPrefix: 'element' },
                { key: 'fachmodelle', label: 'Fachmodelle', hashPrefix: 'model' },
                { key: 'dokumente', label: 'Dokumente', hashPrefix: 'document' },
                { key: 'oekobilanzdaten', label: 'Ökobilanzdaten', hashPrefix: 'epd' }
            ];
            
            let hasAnyResults = false;
            let html = '';
            
            categories.forEach(cat => {
                const items = results[cat.key];
                if (items && items.length > 0) {
                    hasAnyResults = true;
                    html += `<div class="search-dropdown-group">`;
                    html += `<div class="search-dropdown-header">${cat.label}</div>`;
                    items.forEach(item => {
                        html += `<a class="search-dropdown-item" href="#${cat.hashPrefix}/${item.id}">${item.title}</a>`;
                    });
                    html += `</div>`;
                }
            });
            
            if (!hasAnyResults) {
                html = `<div class="search-dropdown-empty">Keine Ergebnisse für "${query}"</div>`;
            }

            // Add "Show all results" footer link
            const encodedQuery = encodeURIComponent(query);
            html += `<a class="search-dropdown-footer" href="#search?q=${encodedQuery}">
                Alle Ergebnisse anzeigen
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </a>`;

            return html;
        }

        // --- SEARCH CLEAR BUTTON HELPER ---
        function setupSearchClearButton(inputId, clearBtnId, onClear) {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);

            if (!input || !clearBtn) return;

            // Update clear button visibility based on input value
            function updateClearVisibility() {
                if (input.value.length > 0) {
                    clearBtn.classList.add('visible');
                } else {
                    clearBtn.classList.remove('visible');
                }
            }

            // Show/hide clear button on input
            input.addEventListener('input', updateClearVisibility);

            // Clear input when button is clicked
            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                input.value = '';
                clearBtn.classList.remove('visible');
                input.focus();
                if (onClear) onClear();
            });

            // Initial visibility check
            updateClearVisibility();
        }

        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            const searchDropdown = document.getElementById('globalSearchDropdown');
            
            if (!searchInput || !searchDropdown) return;
            
            let debounceTimer;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const query = e.target.value;
                
                if (query.length < 2) {
                    searchDropdown.classList.remove('open');
                    return;
                }
                
                debounceTimer = setTimeout(() => {
                    const results = performGlobalSearch(query);
                    searchDropdown.innerHTML = renderSearchDropdown(results, query);
                    searchDropdown.classList.add('open');
                }, 150);
            });
            
            // Close dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.gallery-filter-container') && !e.target.closest('.home-search-container')) {
                    searchDropdown.classList.remove('open');
                }
            });
            
            // Close dropdown on Escape
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    searchDropdown.classList.remove('open');
                    searchInput.blur();
                }
            });
            
            // Close dropdown and navigate on result click
            searchDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('search-dropdown-item') ||
                    e.target.classList.contains('search-dropdown-footer')) {
                    searchDropdown.classList.remove('open');
                    searchInput.value = '';
                    // Hide clear button
                    const clearBtn = document.getElementById('globalSearchClear');
                    if (clearBtn) clearBtn.classList.remove('visible');
                }
            });

            // Setup clear button
            setupSearchClearButton('globalSearchInput', 'globalSearchClear', () => {
                searchDropdown.classList.remove('open');
            });
        }

        // --- HEADER SEARCH (Progressive Disclosure Toggle) ---
        function setupHeaderSearch() {
            const toggle = document.getElementById('headerSearchToggle');
            const searchContainer = document.querySelector('.header__search');
            const form = document.getElementById('headerSearchForm');
            const input = document.getElementById('headerSearchInput');

            if (!toggle || !searchContainer || !form || !input) return;

            let isExpanded = false;

            function expandSearch() {
                isExpanded = true;
                searchContainer.classList.add('open');
                toggle.setAttribute('aria-expanded', 'true');
                // Delay focus slightly to allow animation to start
                setTimeout(() => input.focus(), 100);
            }

            function collapseSearch() {
                isExpanded = false;
                searchContainer.classList.remove('open');
                toggle.setAttribute('aria-expanded', 'false');
            }

            // Toggle search form visibility
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                if (!isExpanded) {
                    expandSearch();
                }
            });

            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = input.value.trim();
                if (query.length >= 2) {
                    collapseSearch();
                    window.location.hash = `search?q=${encodeURIComponent(query)}`;
                }
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (isExpanded && !e.target.closest('.header__search')) {
                    collapseSearch();
                }
            });

            // Close on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isExpanded) {
                    collapseSearch();
                    toggle.focus(); // Return focus to toggle for accessibility
                }
            });

            // Setup clear button
            setupSearchClearButton('headerSearchInput', 'headerSearchClear');
        }

        // --- FULL SEARCH (Search Results Page) ---
        function performFullSearch(query) {
            const results = [];
            const searchTerm = query.toLowerCase().trim();
            if (searchTerm.length < 2) return results;

            // Search Use Cases
            globalUsecasesData.forEach(item => {
                if ((item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'Anwendungsfall',
                        category: 'usecase',
                        id: item.id,
                        title: item.title,
                        description: item.description || '',
                        date: item.date || null
                    });
                }
            });

            // Search Elements
            globalElementsData.forEach(item => {
                if ((item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.classification && item.classification.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'Element',
                        category: 'element',
                        id: item.id,
                        title: item.title,
                        description: item.description || item.classification || '',
                        date: item.date || null
                    });
                }
            });

            // Search Models
            globalModelsData.forEach(item => {
                if ((item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'Fachmodell',
                        category: 'model',
                        id: item.id,
                        title: item.title,
                        description: item.description || '',
                        date: item.date || null
                    });
                }
            });

            // Search Documents
            globalDocumentsData.forEach(item => {
                if ((item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'Dokument',
                        category: 'document',
                        id: item.id,
                        title: item.title,
                        description: item.description || '',
                        date: item.date || null
                    });
                }
            });

            // Search EPDs
            globalEpdsData.forEach(item => {
                if ((item.title && item.title.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'EPD',
                        category: 'epd',
                        id: item.id,
                        title: item.title,
                        description: item.description || '',
                        date: item.date || null
                    });
                }
            });

            // Sort results by date (newest first)
            if (currentSearchSort === 'date-desc') {
                results.sort((a, b) => {
                    if (!a.date && !b.date) return 0;
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return new Date(b.date) - new Date(a.date);
                });
            } else if (currentSearchSort === 'date-asc') {
                results.sort((a, b) => {
                    if (!a.date && !b.date) return 0;
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return new Date(a.date) - new Date(b.date);
                });
            }

            return results;
        }

        function formatSearchDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '';
            return date.toLocaleDateString('de-CH', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function renderSearchResultsPage(query) {
            currentSearchQuery = query || '';
            const results = performFullSearch(currentSearchQuery);
            const resultCount = results.length;

            let resultsHtml = '';
            if (resultCount === 0 && currentSearchQuery.length >= 2) {
                resultsHtml = `
                    <div class="search-results__empty">
                        <div class="search-results__empty-icon"><i data-lucide="search-x" aria-hidden="true"></i></div>
                        <h3 class="search-results__empty-title">Keine Ergebnisse gefunden</h3>
                        <p class="search-results__empty-text">Versuchen Sie es mit anderen Suchbegriffen.</p>
                    </div>
                `;
            } else if (getActiveViewFromURL() === 'list') {
                resultsHtml = `<div class="search-results__list">`;
                results.forEach(item => {
                    const dateStr = formatSearchDate(item.date);
                    resultsHtml += `
                        <div class="search-result-item">
                            <div class="search-result-item__meta">
                                <span class="search-result-item__type">${item.type}</span>
                                ${dateStr ? `<span class="search-result-item__date">${dateStr}</span>` : ''}
                            </div>
                            <h3 class="search-result-item__title"><a href="#${item.category}/${item.id}">${item.title}</a></h3>
                            <p class="search-result-item__desc">${item.description}</p>
                        </div>
                    `;
                });
                resultsHtml += `</div>`;
            } else {
                resultsHtml = `<div class="search-results__grid">`;
                results.forEach(item => {
                    const dateStr = formatSearchDate(item.date);
                    resultsHtml += `
                        <div class="search-result-card">
                            <div class="search-result-card__meta">
                                <span class="search-result-card__type">${item.type}</span>
                                ${dateStr ? `<span class="search-result-card__date">${dateStr}</span>` : ''}
                            </div>
                            <h3 class="search-result-card__title"><a href="#${item.category}/${item.id}">${item.title}</a></h3>
                            <p class="search-result-card__desc">${item.description}</p>
                            <div class="search-result-card__footer">
                                <a href="#${item.category}/${item.id}" class="search-result-card__link" aria-label="${item.title} öffnen">
                                    <i data-lucide="arrow-right" aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    `;
                });
                resultsHtml += `</div>`;
            }

            contentArea.innerHTML = `
                <div class="search-hero">
                    <div class="container">
                        <h1 class="search-hero__title">Suche</h1>
                        <form class="search-hero__form" id="searchPageForm" role="search">
                            <div class="search-hero__input-wrapper">
                                <input type="search" id="searchPageInput" class="search-hero__input" value="${currentSearchQuery}" placeholder="Suchbegriff eingeben..." autocomplete="off">
                                <button type="button" class="search-hero__clear ${currentSearchQuery ? 'visible' : ''}" id="searchPageClear" aria-label="Suche löschen">
                                    <i data-lucide="x" aria-hidden="true"></i>
                                </button>
                                <button type="submit" class="search-hero__submit" aria-label="Suchen">
                                    <i data-lucide="search" aria-hidden="true"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="search-results">
                    <div class="container">
                        ${currentSearchQuery.length >= 2 ? `
                        <div class="search-results__header">
                            <span class="search-results__count">${resultCount} Suchergebnisse</span>
                            <div class="search-results__controls">
                                <button class="search-results__sort" onclick="toggleSearchSort()">
                                    <span>${currentSearchSort === 'date-desc' ? 'Nach Datum sortieren (Absteigend)' : 'Nach Datum sortieren (Aufsteigend)'}</span>
                                    <i data-lucide="chevron-down" aria-hidden="true"></i>
                                </button>
                                <div class="view-switcher toolbar-control">
                                    <button class="view-btn ${getActiveViewFromURL() === 'list' ? 'active' : ''}" onclick="switchSearchView('list')" title="Listenansicht" aria-label="Listenansicht">
                                        <i data-lucide="list" aria-hidden="true"></i>
                                    </button>
                                    <button class="view-btn ${getActiveViewFromURL() === 'grid' ? 'active' : ''}" onclick="switchSearchView('grid')" title="Rasteransicht" aria-label="Rasteransicht">
                                        <i data-lucide="layout-grid" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        ${resultsHtml}
                    </div>
                </div>
            `;

            // Setup search form on results page
            const searchForm = document.getElementById('searchPageForm');
            const searchInput = document.getElementById('searchPageInput');
            if (searchForm && searchInput) {
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newQuery = searchInput.value.trim();
                    if (newQuery.length >= 2) {
                        const view = getActiveViewFromURL();
                        const viewParam = view !== 'grid' ? `&view=${view}` : '';
                        window.location.hash = `search?q=${encodeURIComponent(newQuery)}${viewParam}`;
                    }
                });
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('searchPageInput', 'searchPageClear');
        }

        window.switchSearchView = function(view) {
            // Update URL with view parameter for search results
            const currentView = getActiveViewFromURL();
            if (view !== currentView) {
                const newHash = currentSearchQuery
                    ? `search?q=${encodeURIComponent(currentSearchQuery)}&view=${view}`
                    : `search?view=${view}`;
                window.location.hash = newHash;
            }
        };

        window.toggleSearchSort = function() {
            currentSearchSort = currentSearchSort === 'date-desc' ? 'date-asc' : 'date-desc';
            renderSearchResultsPage(currentSearchQuery);
        };

        // --- PAGE RENDERERS ---
        function renderHomePage() {
            contentArea.innerHTML = `
                <div class="home-hero-section">
                    <h1 class="home-hero__title">Fachdatenkatalog für die digitale Bauwerksdokumentation</h1>
                    <p class="hero__description">Der Fachdatenkatalog der KBOB definiert standardisierte Anforderungen an die BIM-basierte Dokumentation von Hochbauprojekten der öffentlichen Hand in der Schweiz. Er dient als Grundlage für Auftraggeber-Informationsanforderungen (AIA) und BIM-Abwicklungspläne (BAP).</p>
                    <div class="home-search-container">
                        <div class="gallery-filter-wrapper">
                            <input type="text" id="globalSearchInput" class="gallery-filter-input" placeholder="Suche nach Elementen oder Dokumenten..." autocomplete="off">
                            <button type="button" class="search-clear-btn" id="globalSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                            <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                        </div>
                        <div id="globalSearchDropdown" class="search-dropdown"></div>
                    </div>
                </div>

                <!-- Section 2: Themen - Light Background -->
                <section class="home-themen-section">
                    <div class="container home-section">
                        <header class="home-section__header">
                            <h2 class="home-section__title">Themen</h2>
                            <p class="home-section__subtitle">Entdecken Sie die verschiedenen Bereiche des Fachdatenkatalogs</p>
                        </header>
                        <div class="quick-access-grid">
                            <a href="#usecases" class="quick-card" data-route="usecases">
                                <h3 class="quick-card__title">Anwendungsfälle</h3>
                                <p class="quick-card__desc">BIM-Anwendungsfälle für Planung, Koordination und Betrieb</p>
                                <span class="quick-card__arrow-btn" aria-hidden="true"><i data-lucide="arrow-right"></i></span>
                            </a>
                            <a href="#elements" class="quick-card" data-route="elements">
                                <h3 class="quick-card__title">Elemente</h3>
                                <p class="quick-card__desc">Standardisierte BIM-Elemente für den Hochbau mit LOD- und LOI-Anforderungen</p>
                                <span class="quick-card__arrow-btn" aria-hidden="true"><i data-lucide="arrow-right"></i></span>
                            </a>
                            <a href="#models" class="quick-card" data-route="models">
                                <h3 class="quick-card__title">Fachmodelle</h3>
                                <p class="quick-card__desc">Domänenspezifische Modelle für Architektur, Statik und Gebäudetechnik</p>
                                <span class="quick-card__arrow-btn" aria-hidden="true"><i data-lucide="arrow-right"></i></span>
                            </a>
                            <a href="#documents" class="quick-card" data-route="documents">
                                <h3 class="quick-card__title">Dokumente</h3>
                                <p class="quick-card__desc">Dokumenttypen und Vorlagen für die Bauwerksdokumentation</p>
                                <span class="quick-card__arrow-btn" aria-hidden="true"><i data-lucide="arrow-right"></i></span>
                            </a>
                            <a href="#epds" class="quick-card" data-route="epds">
                                <h3 class="quick-card__title">Ökobilanzdaten</h3>
                                <p class="quick-card__desc">Umweltkennwerte für Baumaterialien und Gebäudetechnik</p>
                                <span class="quick-card__arrow-btn" aria-hidden="true"><i data-lucide="arrow-right"></i></span>
                            </a>
                        </div>
                    </div>
                </section>`;

            setupGlobalSearch();

            // Initialize lucide icons for new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup quick card navigation
            document.querySelectorAll('.quick-card[data-route]').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    const route = card.dataset.route;
                    if (route) {
                        window.location.hash = route;
                    }
                });
            });
        }

        function renderHandbookPage() {
            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Handbuch & Downloads</h1>
                        <p class="page-lead">Alle Ressourcen zur Bauwerksdokumentation im Hochbau: Vorlagen, Prüfdateien und technische Schnittstellen.</p>
                    </div>

                    <!-- Handbook Layout with Sticky TOC -->
                    <div class="handbook-layout">
                        <!-- Main Content -->
                        <div class="handbook-main">
                            <!-- Info Sections: Problem, Lösung, Kontext -->
                            <div class="info-sections">
                                <!-- Abschnitt 1: Das Problem -->
                                <article id="silos-zu-standards" class="info-section">
                                    <div class="info-section__content">
                                        <h2 class="info-section__header">Von Silos zu Standards</h2>
                                        <p class="info-section__description">Die Digitalisierung im Bauwesen scheitert oft nicht an fehlender Technologie, sondern an fehlender Datenharmonisierung. Jeder Akteur – von der Architektin über den Fachplaner bis zur Betreiberin – definiert Bauwerksattribute unterschiedlich. Das führt zu Medienbrüchen, manuellen Nachbearbeitungen und Informationsverlust über den gesamten Lebenszyklus. Der KBOB Fachdatenkatalog schafft ein gemeinsames Vokabular: standardisierte Bausteine für BIM-Prozesse, die durchgängige Datenflüsse ermöglichen.</p>
                                    </div>
                                    <figure class="info-section__figure">
                                        <img src="assets/silos.jpg" alt="Datensilos im Bauwesen" class="info-section__image">
                                        <figcaption class="info-section__caption">Ohne gemeinsame Standards bleiben Daten in Silos gefangen. Der Fachdatenkatalog schafft Durchgängigkeit.</figcaption>
                                    </figure>
                                </article>

                                <!-- Abschnitt 2: Die Lösung -->
                                <article id="informationsaustausch" class="info-section">
                                    <div class="info-section__content">
                                        <h2 class="info-section__header">Klare Spielregeln für den Informationsaustausch</h2>
                                        <p class="info-section__description">Im BIM-Prozess nach ISO 19650 definiert der Auftraggeber (AG), welche Informationen er benötigt – der Auftragnehmer (AN) liefert sie. Doch was genau soll geliefert werden? Der Fachdatenkatalog beantwortet diese Frage mit standardisierten LOIN (Level of Information Need): Für jeden Anwendungsfall und jede Projektphase ist definiert, welche geometrischen und alphanumerischen Anforderungen ein Bauelement erfüllen muss. So wird aus abstrakten Auftraggeberinformationsanforderungen (AIA) ein konkreter, prüfbarer Datenstandard.</p>
                                    </div>
                                    <figure class="info-section__figure">
                                        <img src="assets/lifecycle.jpg" alt="Informationsmanagement nach ISO 19650" class="info-section__image">
                                        <figcaption class="info-section__caption">Informationsmanagement nach ISO 19650. Der Fachdatenkatalog definiert die LOIN-Bausteine für den Datenaustausch zwischen Auftraggeber und Auftragnehmer.</figcaption>
                                    </figure>
                                </article>

                                <!-- Abschnitt 3: Der grössere Kontext -->
                                <article id="datenoekosystem" class="info-section">
                                    <div class="info-section__content">
                                        <h2 class="info-section__header">Ein Baustein im Datenökosystem Schweiz</h2>
                                        <p class="info-section__description">Der Fachdatenkatalog ist Teil der Massnahme «Vereinfachung des Bauens durch bessere Dateninteroperabilität» der Strategie Digitale Schweiz und orientiert sich an den Prinzipien der eCH-0279 Architekturvision 2050. Ziel ist ein offener, nicht diskriminierender Standard, der allen Baubeteiligten hilft – von der Entlastung bei Routineaufgaben bis zur nahtlosen Integration von BIM-Daten in Facility-Management-Systeme. Open Source, damit alle profitieren.</p>
                                    </div>
                                    <figure class="info-section__figure">
                                        <img src="assets/ecosystem.jpg" alt="Datenökosystem Schweiz" class="info-section__image">
                                        <figcaption class="info-section__caption">Der Fachdatenkatalog als Teil der Schweizer Datenstrategie – eingebettet in digital.swiss, eCH-Standards und das Datenökosystem Schweiz.</figcaption>
                                    </figure>
                                </article>
                            </div>

                            <h2 id="weitere-informationen" class="info-section__header" style="margin-top: var(--space-xl);">Weitere Informationen</h2>

                            <div class="handbook-accordion">
                        <!-- Downloads Section -->
                        <div class="accordion-item open">
                            <button class="accordion-header" aria-expanded="true">
                                <h2 class="accordion-title">Downloads</h2>
                                <i data-lucide="chevron-down" class="accordion-icon" aria-hidden="true"></i>
                            </button>
                            <div class="accordion-content">
                                <p class="accordion-description">Vorlagen und Prüfdateien für die digitale Bauwerksdokumentation.</p>
                                <ul class="download-list">
                                    <li class="download-item">
                                        <i data-lucide="download" class="download-item__icon" aria-hidden="true"></i>
                                        <div class="download-item__content">
                                            <a href="#" class="download-item__link">EIR-Excel</a>
                                            <div class="download-item__meta">
                                                <span>XLSX</span>
                                                <span>245 kB</span>
                                                <span>15. Oktober 2024</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="download-item">
                                        <i data-lucide="download" class="download-item__icon" aria-hidden="true"></i>
                                        <div class="download-item__content">
                                            <a href="#" class="download-item__link">IDS-Prüfregeln</a>
                                            <div class="download-item__meta">
                                                <span>ZIP</span>
                                                <span>128 kB</span>
                                                <span>15. Oktober 2024</span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Dokumentation Section -->
                        <div class="accordion-item open">
                            <button class="accordion-header" aria-expanded="true">
                                <h2 class="accordion-title">Dokumentation</h2>
                                <i data-lucide="chevron-down" class="accordion-icon" aria-hidden="true"></i>
                            </button>
                            <div class="accordion-content">
                                <p class="accordion-description">Anleitungen und Referenzmaterial für die Anwendung des Fachdatenkatalogs.</p>
                                <ul class="download-list">
                                    <li class="download-item">
                                        <i data-lucide="download" class="download-item__icon" aria-hidden="true"></i>
                                        <div class="download-item__content">
                                            <a href="#" class="download-item__link">Anwendungshandbuch</a>
                                            <div class="download-item__meta">
                                                <span>PDF</span>
                                                <span>2.4 MB</span>
                                                <span>23. September 2024</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="download-item">
                                        <i data-lucide="download" class="download-item__icon" aria-hidden="true"></i>
                                        <div class="download-item__content">
                                            <a href="#" class="download-item__link">API-Dokumentation</a>
                                            <div class="download-item__meta">
                                                <span>PDF</span>
                                                <span>890 kB</span>
                                                <span>23. September 2024</span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Vernetzte Datenquellen Section -->
                        <div class="accordion-item open">
                            <button class="accordion-header" aria-expanded="true">
                                <h2 class="accordion-title">Vernetzte Datenquellen</h2>
                                <i data-lucide="chevron-down" class="accordion-icon" aria-hidden="true"></i>
                            </button>
                            <div class="accordion-content">
                                <p class="accordion-description">Nationale Dateninfrastrukturen und verknüpfte Dienste.</p>
                                <div class="external-item">
                                    <i data-lucide="database" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://lindas.admin.ch/" target="_blank" rel="noopener" class="external-item__link">
                                        LINDAS – Linked Data Service
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="share-2" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.i14y.admin.ch/de/home" target="_blank" rel="noopener" class="external-item__link">
                                        I14Y – Interoperabilitätsplattform
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="languages" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.termdat.bk.admin.ch/" target="_blank" rel="noopener" class="external-item__link">
                                        TERMDAT – Terminologiedatenbank
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="book-open" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.buildingsmart.org/users/services/buildingsmart-data-dictionary/" target="_blank" rel="noopener" class="external-item__link">
                                        bSDD – buildingSMART Data Dictionary
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- APIs Section -->
                        <div class="accordion-item open">
                            <button class="accordion-header" aria-expanded="true">
                                <h2 class="accordion-title">APIs</h2>
                                <i data-lucide="chevron-down" class="accordion-icon" aria-hidden="true"></i>
                            </button>
                            <div class="accordion-content">
                                <p class="accordion-description">Programmatische Schnittstellen für den Datenzugriff.</p>
                                <div class="external-item">
                                    <i data-lucide="arrow-right-left" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="#" class="external-item__link">
                                        REST API
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="git-branch" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="#" class="external-item__link">
                                        GraphQL API
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Links Section -->
                        <div class="accordion-item open">
                            <button class="accordion-header" aria-expanded="true">
                                <h2 class="accordion-title">Links</h2>
                                <i data-lucide="chevron-down" class="accordion-icon" aria-hidden="true"></i>
                            </button>
                            <div class="accordion-content">
                                <p class="accordion-description">Relevante Strategien und Standards für die digitale Transformation im Bauwesen.</p>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.bk.admin.ch/bk/de/home/digitale-transformation-ikt-lenkung/digitale-bundesverwaltung.html" target="_blank" rel="noopener" class="external-item__link">
                                        Strategie Digitale Bundesverwaltung
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://digital.swiss/de/aktionsplan/massnahme/vereinfachung-des-bauens-durch-bessere-dateninteroperabilitat" target="_blank" rel="noopener" class="external-item__link">
                                        BIM - Vereinfachung der Prozesse im Bauwesen durch bessere Dateninteroperabilität
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.kbob.admin.ch/de/digitalisierung-und-bim" target="_blank" rel="noopener" class="external-item__link">
                                        Strategie digitale Methoden der BLO und des ASTRA
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.ech.ch/de/ech/ech-0279/1.0.0" target="_blank" rel="noopener" class="external-item__link">
                                        eCH-0279 Architekturvision 2050
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.ech.ch/de/ech/ech-0122/2.0.0" target="_blank" rel="noopener" class="external-item__link">
                                        eCH-0122 Architektur E-Government Schweiz: Grundlagen
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.bk.admin.ch/bk/de/home/digitale-transformation-ikt-lenkung/datenoekosystem_schweiz.html" target="_blank" rel="noopener" class="external-item__link">
                                        Datenökosystem Schweiz
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="external-item">
                                    <i data-lucide="link" class="external-item__icon" aria-hidden="true"></i>
                                    <a href="https://www.bk.admin.ch/bk/de/home/digitale-transformation-ikt-lenkung/bundesarchitektur/register.html" target="_blank" rel="noopener" class="external-item__link">
                                        Register
                                        <i data-lucide="external-link" class="external-icon" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Sticky Table of Contents -->
                        <aside class="handbook-toc" aria-label="Inhaltsverzeichnis">
                            <h2 class="handbook-toc__title">Inhaltsverzeichnis</h2>
                            <nav>
                                <ul class="handbook-toc__list">
                                    <li class="handbook-toc__item active">
                                        <a href="#silos-zu-standards" class="handbook-toc__link">
                                            <span>Von Silos zu Standards</span>
                                            <i data-lucide="corner-down-left" class="handbook-toc__icon" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    <li class="handbook-toc__item">
                                        <a href="#informationsaustausch" class="handbook-toc__link">
                                            <span>Klare Spielregeln für den Informationsaustausch</span>
                                            <i data-lucide="corner-down-left" class="handbook-toc__icon" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    <li class="handbook-toc__item">
                                        <a href="#datenoekosystem" class="handbook-toc__link">
                                            <span>Ein Baustein im Datenökosystem Schweiz</span>
                                            <i data-lucide="corner-down-left" class="handbook-toc__icon" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    <li class="handbook-toc__item">
                                        <a href="#weitere-informationen" class="handbook-toc__link">
                                            <span>Weitere Informationen</span>
                                            <i data-lucide="corner-down-left" class="handbook-toc__icon" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </aside>
                    </div>
                </div>`;

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Initialize accordion functionality
            initAccordion();

            // Initialize sticky TOC for handbook page
            initHandbookToc();
        }

        function initAccordion() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const item = header.parentElement;
                    const isOpen = item.classList.contains('open');

                    // Toggle current item
                    item.classList.toggle('open');
                    header.setAttribute('aria-expanded', !isOpen);
                });
            });
        }

        // Initialize sticky TOC with scroll highlighting
        function initHandbookToc() {
            const tocItems = document.querySelectorAll('.handbook-toc__item');
            const sections = document.querySelectorAll('.info-section[id], h2[id]');

            if (!tocItems.length || !sections.length) return;

            // Intersection Observer for scroll-based highlighting
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -60% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const targetId = entry.target.id;
                        tocItems.forEach(item => {
                            const link = item.querySelector('a');
                            if (link && link.getAttribute('href') === '#' + targetId) {
                                item.classList.add('active');
                            } else {
                                item.classList.remove('active');
                            }
                        });
                    }
                });
            }, observerOptions);

            sections.forEach(section => observer.observe(section));

            // Smooth scroll on TOC link click
            tocItems.forEach(item => {
                const link = item.querySelector('a');
                if (link) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);
                        const target = document.getElementById(targetId);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                }
            });
        }

        function renderCatalogPage(activeTags = [], activeCategory = '') {
            // Apply both category and tag filtering
            let filteredData = filterDataByCategory(globalElementsData, activeCategory);
            filteredData = filterDataByTags(filteredData, activeTags);

            const filterPanelClass = elementsFilterVisible ? '' : 'closed';
            const currentView = getActiveViewFromURL();
            const gridActive = currentView === 'grid' ? 'active' : '';
            const listActive = currentView === 'list' ? 'active' : '';
            const activeFiltersCount = activeTags.length + (activeCategory ? 1 : 0);

            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Elemente</h1>
                        <p class="page-lead">Standardisierte BIM-Elemente für den Hochbau mit LOD- und LOI-Anforderungen pro Projektphase.</p>
                    </div>
                    <div class="gallery-filter-container">
                        <div class="gallery-filter-left">
                            <div class="gallery-filter-wrapper">
                                <input type="text" id="catalogSearchInput" class="gallery-filter-input" placeholder="Suche nach Elementen oder Klassifikation...">
                                <button type="button" class="search-clear-btn" id="catalogSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                                <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                            </div>
                            ${renderFilterButton('elements', elementsFilterVisible, activeFiltersCount)}
                        </div>
                        <div class="view-switcher toolbar-control">
                            <button class="view-btn ${listActive}" onclick="switchView('list')" aria-label="Listenansicht"><i data-lucide="list" aria-hidden="true"></i></button>
                            <button class="view-btn ${gridActive}" onclick="switchView('grid')" aria-label="Rasteransicht"><i data-lucide="layout-grid" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    ${renderFilterBar({
                        data: globalElementsData,
                        activeTags: activeTags,
                        activeCategory: activeCategory,
                        filterPanelClass: filterPanelClass
                    })}

                    <div id="catalogContent" class="catalog-content">
                        ${currentView === 'grid'
                            ? `<div class="element-grid">${renderGridItemsHTML(filteredData, activeTags, activeCategory)}</div>`
                            : renderListItemsHTML(filteredData, activeTags, activeCategory)
                        }
                    </div>
                </div>`;

            const searchInput = document.getElementById('catalogSearchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    document.querySelectorAll('.az-btn').forEach(b => b.classList.remove('active'));
                    const searchTerm = e.target.value.toLowerCase();

                    // First filter by category and tags, then by search term
                    let searchFilteredData = filterDataByCategory(globalElementsData, activeCategory);
                    searchFilteredData = filterDataByTags(searchFilteredData, activeTags);
                    searchFilteredData = searchFilteredData.filter(el =>
                        (el.title && el.title.toLowerCase().includes(searchTerm)) ||
                        (el.classification && el.classification.toLowerCase().includes(searchTerm))
                    );

                    const container = document.getElementById('catalogContent');
                    container.innerHTML = (getActiveViewFromURL() === 'grid')
                        ? `<div class="element-grid">${renderGridItemsHTML(searchFilteredData, activeTags, activeCategory)}</div>`
                        : renderListItemsHTML(searchFilteredData, activeTags, activeCategory);
                });
            }

            // Re-initialize Lucide icons after rendering
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('catalogSearchInput', 'catalogSearchClear');
        }

        function renderDocumentsCatalogPage(activeTags = [], activeCategory = '') {
            // Apply both category and tag filtering
            let filteredData = filterDataByCategory(globalDocumentsData, activeCategory);
            filteredData = filterDataByTags(filteredData, activeTags);

            const filterPanelClass = documentsFilterVisible ? '' : 'closed';
            const currentView = getActiveViewFromURL();
            const gridActive = currentView === 'grid' ? 'active' : '';
            const listActive = currentView === 'list' ? 'active' : '';
            const activeFiltersCount = activeTags.length + (activeCategory ? 1 : 0);

            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Dokumente</h1>
                        <p class="page-lead">Dokumenttypen und Vorlagen für die standardisierte Bauwerksdokumentation im Hochbau.</p>
                    </div>
                    <div class="gallery-filter-container">
                        <div class="gallery-filter-left">
                            <div class="gallery-filter-wrapper">
                                <input type="text" id="documentsSearchInput" class="gallery-filter-input" placeholder="Suche nach Dokumenten oder Kategorie...">
                                <button type="button" class="search-clear-btn" id="documentsSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                                <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                            </div>
                            ${renderFilterButton('documents', documentsFilterVisible, activeFiltersCount)}
                        </div>
                        <div class="view-switcher toolbar-control">
                            <button class="view-btn ${listActive}" onclick="switchView('list')" aria-label="Listenansicht"><i data-lucide="list" aria-hidden="true"></i></button>
                            <button class="view-btn ${gridActive}" onclick="switchView('grid')" aria-label="Rasteransicht"><i data-lucide="layout-grid" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    ${renderFilterBar({
                        data: globalDocumentsData,
                        activeTags: activeTags,
                        activeCategory: activeCategory,
                        filterPanelClass: filterPanelClass
                    })}

                    <div id="documentsContent" class="catalog-content">
                        ${currentView === 'grid'
                            ? `<div class="element-grid">${renderDocGridItemsHTML(filteredData, activeTags, activeCategory)}</div>`
                            : renderDocListItemsHTML(filteredData, activeTags, activeCategory)
                        }
                    </div>
                </div>`;

            const searchInput = document.getElementById('documentsSearchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    document.querySelectorAll('.az-btn').forEach(b => b.classList.remove('active'));
                    const searchTerm = e.target.value.toLowerCase();

                    // First filter by category and tags, then by search term
                    let searchFilteredData = filterDataByCategory(globalDocumentsData, activeCategory);
                    searchFilteredData = filterDataByTags(searchFilteredData, activeTags);
                    searchFilteredData = searchFilteredData.filter(doc =>
                        (doc.title && doc.title.toLowerCase().includes(searchTerm)) ||
                        (doc.category && doc.category.toLowerCase().includes(searchTerm)) ||
                        (doc.description && doc.description.toLowerCase().includes(searchTerm))
                    );

                    const container = document.getElementById('documentsContent');
                    container.innerHTML = (getActiveViewFromURL() === 'grid')
                        ? `<div class="element-grid">${renderDocGridItemsHTML(searchFilteredData, activeTags, activeCategory)}</div>`
                        : renderDocListItemsHTML(searchFilteredData, activeTags, activeCategory);
                });
            }

            // Re-initialize Lucide icons after rendering
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('documentsSearchInput', 'documentsSearchClear');
        }

        function renderElementDetailPage(id, activeTags = []) {
            const data = globalElementsData.find(element => element.id === id);
            if(!data) { 
                contentArea.innerHTML = '<div class="container error-state">Element nicht gefunden.</div>'; 
                return; 
            }

            const sidebarLinks = [
                { id: 'klassifizierung', text: 'Klassifizierung' },
                { id: 'ifc', text: 'IFC-Klasse' },
                { id: 'geometrie', text: 'Geometrie' },
                { id: 'informationen', text: 'Informationen' },
                { id: 'dokumentation', text: 'Dokumentation' }
            ].map(link => `<a href="#${link.id}" class="sidebar-link" data-target="${link.id}">${link.text}</a>`).join('');

            const classRows = data.classifications 
                ? data.classifications.map(c => `<tr><td class="col-val">${c.system}</td><td class="col-val">${c.code} - ${c.desc}</td></tr>`).join('') 
                : '<tr><td colspan="2">Keine Klassifizierung verfügbar</td></tr>';

            const ifcRows = data.ifcMapping 
                ? data.ifcMapping.map(m => `
                    <tr>
                        <td class="col-val">${m.element}</td>
                        <td class="col-val">${m.ifc}</td>
                        <td class="col-val">${m.revit}</td>
                    </tr>`).join('') 
                : '<tr><td colspan="3">-</td></tr>';

            const geomRows = data.geometry && data.geometry.length > 0 ? data.geometry : [];
            const geomRowsHtml = geomRows.length > 0 
                ? geomRows.map(row => `
                    <tr>
                        <td class="col-val">${row.name}</td>
                        <td class="col-val">${row.desc}</td>
                        <td class="col-center">${renderPhaseBadges(row.phases)}</td>
                    </tr>`).join('') 
                : '<tr><td colspan="3" class="col-center empty-text">Keine Daten.</td></tr>';

            const infoRows = data.information && data.information.length > 0 ? data.information : [];
            const infoRowsHtml = infoRows.length > 0 
                ? infoRows.map(row => `
                    <tr>
                        <td class="col-val"><span class="info-name-tooltip" title="${row.desc || ''}">${row.name}</span></td>
                        <td class="col-val">${row.format || '-'}</td>
                        <td class="col-center">${row.list ? '<i data-lucide="circle-check" class="list-icon-active"></i>' : '-'}</td>
                        <td class="col-val">${row.ifc || '-'}</td>
                        <td class="col-center">${renderPhaseBadges(row.phases)}</td>
                    </tr>`).join('') 
                : '<tr><td colspan="5" class="col-center empty-text">Keine Attribute (LOI).</td></tr>';

            const docRows = data.documentation && data.documentation.length > 0 ? data.documentation : [];
            const docRowsHtml = docRows.length > 0 
                ? docRows.map(row => `
                    <tr>
                        <td class="col-val">${row.name}</td>
                        <td class="col-val">${row.desc}</td>
                        <td class="col-center">${renderPhaseBadges(row.phases)}</td>
                    </tr>`).join('') 
                : '<tr><td colspan="3" class="col-center empty-text">Keine Dokumente.</td></tr>';

            // Build back link with tags and view preserved
            const backLink = buildHashWithTags('elements', activeTags, '', [], getActiveViewFromURL());

            contentArea.innerHTML = `
                <section class="detail-hero">
                    <div class="container detail-hero__inner">
                        <div class="hero-content">
                            <div class="breadcrumb"><a href="#${backLink}"><i data-lucide="arrow-left" style="vertical-align: text-bottom; margin-right:5px; width: 1.1rem; height: 1.1rem;"></i> Zurück zur Liste</a></div>
                            <h1 class="hero-title">${data.title}</h1>
                            <p class="hero-subtitle">${data.description || 'Ein Standard-Element des KBOB Datenkatalogs.'}</p>
                            <div class="hero-tags">${renderTagsHtml(data.tags, activeTags)}</div>
                        </div>
                        <div class="hero-image-container">
                            ${data.image ? `<img src="${data.image}" alt="${data.title}">` : '<i data-lucide="image" class="hero-image-placeholder icon--4xl"></i>'}
                        </div>
                    </div>
                </section>

                <div class="container">
                    <div class="detail-layout">
                        <aside class="detail-sidebar"><nav class="sticky-nav">${sidebarLinks}</nav></aside>
                        <div class="detail-content-area">
                            <div id="klassifizierung" class="detail-section">
                                <h2>Klassifizierung</h2>
                                <table class="data-table">
                                    <thead><tr><th class="th-w-20">Klassifizierung</th><th>Nummer - Beschreibung</th></tr></thead>
                                    <tbody>${classRows}</tbody>
                                </table>
                            </div>
                            
                            <div id="ifc" class="detail-section">
                                <h2>IFC-Klasse</h2>
                                <table class="data-table">
                                    <thead><tr><th class="th-w-20">Element</th><th>IFC 4.3</th><th>Revit ENG</th></tr></thead>
                                    <tbody>${ifcRows}</tbody>
                                </table>
                            </div>
                            
                            <div id="geometrie" class="detail-section">
                                <h2>Geometrie</h2>
                                <p>Definiert die geometrischen Anforderungen an das Modellelement pro Phase.</p>
                                <table class="data-table">
                                    <thead><tr><th class="th-w-20">Element</th><th>Beschreibung</th><th class="th-w-phases">Phasen (1-5)</th></tr></thead>
                                    <tbody>${geomRowsHtml}</tbody>
                                </table>
                            </div>
                            
                            <div id="informationen" class="detail-section">
                                <h2>Informationen</h2>
                                <p>Alphanumerische Attribute (LOI), die dem Element zugewiesen werden müssen.</p>
                                <table class="data-table">
                                    <thead><tr>
                                        <th class="th-w-20">Name</th>
                                        <th class="th-w-format">Format</th>
                                        <th class="th-w-list">Liste</th>
                                        <th>IFC Mapping</th>
                                        <th class="th-w-phases">Phasen (1-5)</th>
                                    </tr></thead>
                                    <tbody>${infoRowsHtml}</tbody>
                                </table>
                            </div>
                            
                            <div id="dokumentation" class="detail-section">
                                <h2>Dokumentation</h2>
                                <p>Erforderliche Dokumente, die mit dem Element verknüpft oder geliefert werden müssen.</p>
                                <table class="data-table">
                                    <thead><tr><th class="th-w-20">Dokumententyp</th><th>Beschreibung</th><th class="th-w-phases">Phasen (1-5)</th></tr></thead>
                                    <tbody>${docRowsHtml}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            setupDetailInteractions();
        }

        function renderDocumentDetailPage(id, activeTags = [], activeCategory = '') {
            const data = globalDocumentsData.find(doc => doc.id === id);
            if(!data) {
                contentArea.innerHTML = '<div class="container error-state">Dokument nicht gefunden. Detail-Seite für Dokumente ist noch in Entwicklung.</div>';
                return;
            }

            // Build back link with tags, category, and view preserved
            const backLink = buildHashWithTags('documents', activeTags, activeCategory, [], getActiveViewFromURL());
            
            contentArea.innerHTML = `
                <section class="detail-hero">
                    <div class="container detail-hero__inner">
                        <div class="hero-content">
                            <div class="breadcrumb"><a href="#${backLink}"><i data-lucide="arrow-left" style="vertical-align: text-bottom; margin-right:5px; width: 1.1rem; height: 1.1rem;"></i> Zurück zur Liste</a></div>
                            <h1 class="hero-title">${data.title}</h1>
                            <p class="hero-subtitle">${data.description || 'Ein Dokument des KBOB Datenkatalogs.'}</p>
                            <div class="hero-tags">${renderTagsHtml(data.tags, activeTags)}</div>
                        </div>
                        <div class="hero-image-container">
                            ${data.image ? `<img src="${data.image}" alt="${data.title}">` : '<i data-lucide="file-text" class="hero-image-placeholder icon--4xl"></i>'}
                        </div>
                    </div>
                </section>
                <div class="container">
                    <div class="info-box info-box--centered">
                        <i data-lucide="hard-hat" class="info-box__icon icon--4xl"></i>
                        <h2 class="info-box__title">In Entwicklung</h2>
                        <p class="info-box__text">Die Detail-Ansicht für Dokumente wird derzeit entwickelt.</p>
                    </div>
                </div>`;
        }

        // ============================================
        // USECASES CATALOG AND DETAIL PAGES
        // ============================================

        function renderUsecasesCatalogPage(activeTags = [], activeCategory = '') {
            // Get active phases from URL
            const activePhases = getActivePhasesFromURL();

            // Apply category, tag, and phases filtering
            let filteredData = filterDataByCategory(globalUsecasesData, activeCategory);
            filteredData = filterDataByTags(filteredData, activeTags);
            filteredData = filterDataByPhases(filteredData, activePhases);

            const filterPanelClass = usecasesFilterVisible ? '' : 'closed';
            const currentView = getActiveViewFromURL();
            const gridActive = currentView === 'grid' ? 'active' : '';
            const listActive = currentView === 'list' ? 'active' : '';
            const activeFiltersCount = activeTags.length + (activeCategory ? 1 : 0) + activePhases.length;

            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Anwendungsfälle</h1>
                        <p class="page-lead">BIM-Anwendungsfälle für Planung, Koordination, Kostenmanagement und Betrieb.</p>
                    </div>
                    <div class="gallery-filter-container">
                        <div class="gallery-filter-left">
                            <div class="gallery-filter-wrapper">
                                <input type="text" id="usecasesSearchInput" class="gallery-filter-input" placeholder="Suche nach Anwendungsfällen...">
                                <button type="button" class="search-clear-btn" id="usecasesSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                                <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                            </div>
                            ${renderFilterButton('usecases', usecasesFilterVisible, activeFiltersCount)}
                        </div>
                        <div class="view-switcher toolbar-control">
                            <button class="view-btn ${listActive}" onclick="switchView('list')" aria-label="Listenansicht"><i data-lucide="list" aria-hidden="true"></i></button>
                            <button class="view-btn ${gridActive}" onclick="switchView('grid')" aria-label="Rasteransicht"><i data-lucide="layout-grid" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    ${renderFilterBar({
                        data: globalUsecasesData,
                        activeTags: activeTags,
                        activeCategory: activeCategory,
                        activePhases: activePhases,
                        showPhases: true,
                        filterPanelClass: filterPanelClass
                    })}

                    <div id="usecasesContent" class="catalog-content">
                        ${currentView === 'grid'
                            ? `<div class="element-grid">${renderUsecasesGridItemsHTML(filteredData, activeTags, activeCategory)}</div>`
                            : renderUsecasesListItemsHTML(filteredData, activeTags, activeCategory)
                        }
                    </div>
                </div>`;

            const searchInput = document.getElementById('usecasesSearchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    let searchFilteredData = filterDataByCategory(globalUsecasesData, activeCategory);
                    searchFilteredData = filterDataByTags(searchFilteredData, activeTags);
                    searchFilteredData = filterDataByPhases(searchFilteredData, activePhases);
                    searchFilteredData = searchFilteredData.filter(item =>
                        (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    );
                    const container = document.getElementById('usecasesContent');
                    container.innerHTML = (getActiveViewFromURL() === 'grid')
                        ? `<div class="element-grid">${renderUsecasesGridItemsHTML(searchFilteredData, activeTags, activeCategory)}</div>`
                        : renderUsecasesListItemsHTML(searchFilteredData, activeTags, activeCategory);
                });
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('usecasesSearchInput', 'usecasesSearchClear');
        }

        function renderUsecaseDetailPage(id, activeTags = [], activeCategory = '') {
            const data = globalUsecasesData.find(item => item.id === id);
            if(!data) {
                contentArea.innerHTML = '<div class="container error-state">Anwendungsfall nicht gefunden.</div>';
                return;
            }

            const backLink = buildHashWithTags('usecases', activeTags, activeCategory, [], getActiveViewFromURL());

            // Sidebar navigation links
            const sidebarLinksData = [
                { id: 'phasen', text: 'Phasen' },
                { id: 'ziele', text: 'Ziele' },
                { id: 'rollen', text: 'Rollen' },
                { id: 'eingaben', text: 'Eingaben' },
                { id: 'ausgaben', text: 'Ausgaben' },
                ...(data.process_url ? [{ id: 'prozess', text: 'Prozess' }] : []),
                { id: 'verknuepfungen', text: 'Verknüpfungen' }
            ];
            const sidebarLinks = sidebarLinksData.map(link => `<a href="#${link.id}" class="sidebar-link" data-target="${link.id}">${link.text}</a>`).join('');

            // Render phases dynamically from phaseLabels, highlight active ones
            const allPhases = Object.keys(phaseLabels).map(Number).sort((a, b) => a - b);
            const phasesHtml = allPhases.map(p => {
                const isActive = data.phases && data.phases.includes(p);
                return `<span class="phase-badge ${isActive ? 'active' : 'inactive'}" title="Phase ${p}">${p}</span>`;
            }).join('');

            // Render goals as table
            const goalsRowsHtml = data.goals && data.goals.length > 0
                ? data.goals.map(goal => `<tr><td class="col-val">${goal}</td></tr>`).join('')
                : '<tr><td class="col-center empty-text">Keine Ziele definiert.</td></tr>';

            // Render inputs table
            const inputsRowsHtml = data.inputs && data.inputs.length > 0
                ? data.inputs.map(input => `<tr><td class="col-val">${input}</td></tr>`).join('')
                : '<tr><td class="col-center empty-text">Keine Eingaben definiert.</td></tr>';

            // Render outputs table
            const outputsRowsHtml = data.outputs && data.outputs.length > 0
                ? data.outputs.map(output => `<tr><td class="col-val">${output}</td></tr>`).join('')
                : '<tr><td class="col-center empty-text">Keine Ausgaben definiert.</td></tr>';

            // Render roles RACI table (without bullet points)
            const rolesRowsHtml = data.roles && data.roles.length > 0
                ? data.roles.map(role => `
                    <tr>
                        <td class="col-val col-actor">${role.actor}</td>
                        <td class="col-val">${role.responsible && role.responsible.length > 0 ? role.responsible.join(', ') : '-'}</td>
                        <td class="col-val">${role.contributing && role.contributing.length > 0 ? role.contributing.join(', ') : '-'}</td>
                        <td class="col-val">${role.informed && role.informed.length > 0 ? role.informed.join(', ') : '-'}</td>
                    </tr>`).join('')
                : '<tr><td colspan="4" class="col-center empty-text">Keine Rollen definiert.</td></tr>';

            contentArea.innerHTML = `
                <section class="detail-hero">
                    <div class="container detail-hero__inner">
                        <div class="hero-content">
                            <div class="breadcrumb"><a href="#${backLink}"><i data-lucide="arrow-left" style="vertical-align: text-bottom; margin-right:5px; width: 1.1rem; height: 1.1rem;"></i> Zurück zur Liste</a></div>
                            <h1 class="hero-title">${data.title}</h1>
                            <p class="hero-subtitle">${data.description || 'Ein Anwendungsfall des KBOB Datenkatalogs.'}</p>
                            <div class="hero-tags">${renderTagsHtml(data.tags, activeTags)}</div>
                        </div>
                        <div class="hero-image-container">
                            ${data.image ? `<img src="${data.image}" alt="${data.title}">` : '<i data-lucide="workflow" class="hero-image-placeholder icon--4xl"></i>'}
                        </div>
                    </div>
                </section>

                <div class="container">
                    <div class="detail-layout">
                        <aside class="detail-sidebar"><nav class="sticky-nav">${sidebarLinks}</nav></aside>
                        <div class="detail-content-area">
                            <div class="detail-section" id="phasen">
                                <h2>Projektphasen</h2>
                                <p>Relevante Projektphasen für diesen Anwendungsfall.</p>
                                <div class="phases-container phases-container--large">${phasesHtml}</div>
                            </div>

                            <div class="detail-section" id="ziele">
                                <h2>Ziele</h2>
                                <table class="data-table">
                                    <thead><tr><th>Beschreibung</th></tr></thead>
                                    <tbody>${goalsRowsHtml}</tbody>
                                </table>
                            </div>

                            <div class="detail-section" id="rollen">
                                <h2>Rollen & Verantwortlichkeiten</h2>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="th-w-20">Akteur</th>
                                            <th>Verantwortlich (R)</th>
                                            <th>Mitwirkend (C)</th>
                                            <th>Informiert (I)</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rolesRowsHtml}</tbody>
                                </table>
                            </div>

                            <div class="detail-section" id="eingaben">
                                <h2>Eingaben</h2>
                                <p>Erforderliche Informationen und Dokumente für diesen Anwendungsfall.</p>
                                <table class="data-table">
                                    <thead><tr><th>Bezeichnung</th></tr></thead>
                                    <tbody>${inputsRowsHtml}</tbody>
                                </table>
                            </div>

                            <div class="detail-section" id="ausgaben">
                                <h2>Ausgaben</h2>
                                <p>Ergebnisse und Lieferobjekte dieses Anwendungsfalls.</p>
                                <table class="data-table">
                                    <thead><tr><th>Bezeichnung</th></tr></thead>
                                    <tbody>${outputsRowsHtml}</tbody>
                                </table>
                            </div>

                            ${data.process_url ? `
                            <div class="detail-section" id="prozess">
                                <h2>Prozess</h2>
                                <p>BPMN-Prozessdiagramm für diesen Anwendungsfall.</p>
                                <div class="bpmn-viewer-container">
                                    <iframe
                                        src="${data.process_url}"
                                        title="BPMN Prozessdiagramm"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>` : ''}

                            <div class="detail-section" id="verknuepfungen">
                                <h2>Verknüpfungen</h2>
                                <p>Verknüpfte Dokumente und Elemente für diesen Anwendungsfall.</p>
                                <div class="info-box info-box--inline">
                                    <i data-lucide="construction" class="info-box__icon"></i>
                                    <div>
                                        <p class="info-box__text">Diese Funktion wird derzeit entwickelt. Hier werden zukünftig verknüpfte Dokumente und Elemente angezeigt.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            setupDetailInteractions();
        }

        // ============================================
        // MODELS CATALOG AND DETAIL PAGES
        // ============================================

        function renderModelsCatalogPage(activeTags = [], activeCategory = '') {
            // Apply both category and tag filtering
            let filteredData = filterDataByCategory(globalModelsData, activeCategory);
            filteredData = filterDataByTags(filteredData, activeTags);

            const filterPanelClass = modelsFilterVisible ? '' : 'closed';
            const currentView = getActiveViewFromURL();
            const gridActive = currentView === 'grid' ? 'active' : '';
            const listActive = currentView === 'list' ? 'active' : '';
            const activeFiltersCount = activeTags.length + (activeCategory ? 1 : 0);

            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Fachmodelle</h1>
                        <p class="page-lead">Domänenspezifische BIM-Modelle für Architektur, Tragwerk, Haustechnik und weitere Fachbereiche.</p>
                    </div>
                    <div class="gallery-filter-container">
                        <div class="gallery-filter-left">
                            <div class="gallery-filter-wrapper">
                                <input type="text" id="modelsSearchInput" class="gallery-filter-input" placeholder="Suche nach Fachmodellen...">
                                <button type="button" class="search-clear-btn" id="modelsSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                                <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                            </div>
                            ${renderFilterButton('models', modelsFilterVisible, activeFiltersCount)}
                        </div>
                        <div class="view-switcher toolbar-control">
                            <button class="view-btn ${listActive}" onclick="switchView('list')" aria-label="Listenansicht"><i data-lucide="list" aria-hidden="true"></i></button>
                            <button class="view-btn ${gridActive}" onclick="switchView('grid')" aria-label="Rasteransicht"><i data-lucide="layout-grid" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    ${renderFilterBar({
                        data: globalModelsData,
                        activeTags: activeTags,
                        activeCategory: activeCategory,
                        filterPanelClass: filterPanelClass
                    })}

                    <div id="modelsContent" class="catalog-content">
                        ${currentView === 'grid'
                            ? `<div class="element-grid">${renderModelsGridItemsHTML(filteredData, activeTags, activeCategory)}</div>`
                            : renderModelsListItemsHTML(filteredData, activeTags, activeCategory)
                        }
                    </div>
                </div>`;

            const searchInput = document.getElementById('modelsSearchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    let searchFilteredData = filterDataByCategory(globalModelsData, activeCategory);
                    searchFilteredData = filterDataByTags(searchFilteredData, activeTags);
                    searchFilteredData = searchFilteredData.filter(item =>
                        (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    );
                    const container = document.getElementById('modelsContent');
                    container.innerHTML = (getActiveViewFromURL() === 'grid')
                        ? `<div class="element-grid">${renderModelsGridItemsHTML(searchFilteredData, activeTags, activeCategory)}</div>`
                        : renderModelsListItemsHTML(searchFilteredData, activeTags, activeCategory);
                });
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('modelsSearchInput', 'modelsSearchClear');
        }

        function renderModelDetailPage(id, activeTags = [], activeCategory = '') {
            const data = globalModelsData.find(item => item.id === id);
            if(!data) {
                contentArea.innerHTML = '<div class="container error-state">Fachmodell nicht gefunden.</div>';
                return;
            }

            const backLink = buildHashWithTags('models', activeTags, activeCategory, [], getActiveViewFromURL());

            contentArea.innerHTML = `
                <section class="detail-hero">
                    <div class="container detail-hero__inner">
                        <div class="hero-content">
                            <div class="breadcrumb"><a href="#${backLink}"><i data-lucide="arrow-left" style="vertical-align: text-bottom; margin-right:5px; width: 1.1rem; height: 1.1rem;"></i> Zurück zur Liste</a></div>
                            <h1 class="hero-title">${data.title}</h1>
                            <p class="hero-subtitle">${data.description || 'Ein Fachmodell des KBOB Datenkatalogs.'}</p>
                            <div class="hero-tags">${renderTagsHtml(data.tags, activeTags)}</div>
                        </div>
                        <div class="hero-image-container">
                            ${data.image ? `<img src="${data.image}" alt="${data.title}">` : '<i data-lucide="boxes" class="hero-image-placeholder icon--4xl"></i>'}
                        </div>
                    </div>
                </section>
                <div class="container">
                    <div class="info-box info-box--centered">
                        <i data-lucide="hard-hat" class="info-box__icon icon--4xl"></i>
                        <h2 class="info-box__title">In Entwicklung</h2>
                        <p class="info-box__text">Die Detail-Ansicht für Fachmodelle wird derzeit entwickelt.</p>
                    </div>
                </div>`;
        }

        // ============================================
        // EPDS CATALOG AND DETAIL PAGES
        // ============================================

        function renderEpdsCatalogPage(activeTags = [], activeCategory = '') {
            // Apply both category and tag filtering
            let filteredData = filterDataByCategory(globalEpdsData, activeCategory);
            filteredData = filterDataByTags(filteredData, activeTags);

            const filterPanelClass = epdsFilterVisible ? '' : 'closed';
            const currentView = getActiveViewFromURL();
            const gridActive = currentView === 'grid' ? 'active' : '';
            const listActive = currentView === 'list' ? 'active' : '';
            const activeFiltersCount = activeTags.length + (activeCategory ? 1 : 0);

            contentArea.innerHTML = `
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Ökobilanzdaten</h1>
                        <p class="page-lead">Umweltproduktdeklarationen (EPD) und Ökobilanzkennwerte für Baumaterialien und Gebäudetechnik.</p>
                    </div>
                    <div class="gallery-filter-container">
                        <div class="gallery-filter-left">
                            <div class="gallery-filter-wrapper">
                                <input type="text" id="epdsSearchInput" class="gallery-filter-input" placeholder="Suche nach Ökobilanzdaten...">
                                <button type="button" class="search-clear-btn" id="epdsSearchClear" aria-label="Suche löschen"><i data-lucide="x" aria-hidden="true"></i></button>
                                <button class="gallery-filter-btn" aria-label="Suchen"><i data-lucide="search" aria-hidden="true"></i></button>
                            </div>
                            ${renderFilterButton('epds', epdsFilterVisible, activeFiltersCount)}
                        </div>
                        <div class="view-switcher toolbar-control">
                            <button class="view-btn ${listActive}" onclick="switchView('list')" aria-label="Listenansicht"><i data-lucide="list" aria-hidden="true"></i></button>
                            <button class="view-btn ${gridActive}" onclick="switchView('grid')" aria-label="Rasteransicht"><i data-lucide="layout-grid" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    ${renderFilterBar({
                        data: globalEpdsData,
                        activeTags: activeTags,
                        activeCategory: activeCategory,
                        filterPanelClass: filterPanelClass
                    })}

                    <div id="epdsContent" class="catalog-content">
                        ${currentView === 'grid'
                            ? `<div class="element-grid">${renderEpdsGridItemsHTML(filteredData, activeTags, activeCategory)}</div>`
                            : renderEpdsListItemsHTML(filteredData, activeTags, activeCategory)
                        }
                    </div>
                </div>`;

            const searchInput = document.getElementById('epdsSearchInput');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    let searchFilteredData = filterDataByCategory(globalEpdsData, activeCategory);
                    searchFilteredData = filterDataByTags(searchFilteredData, activeTags);
                    searchFilteredData = searchFilteredData.filter(item =>
                        (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    );
                    const container = document.getElementById('epdsContent');
                    container.innerHTML = (getActiveViewFromURL() === 'grid')
                        ? `<div class="element-grid">${renderEpdsGridItemsHTML(searchFilteredData, activeTags, activeCategory)}</div>`
                        : renderEpdsListItemsHTML(searchFilteredData, activeTags, activeCategory);
                });
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Setup clear button
            setupSearchClearButton('epdsSearchInput', 'epdsSearchClear');
        }

        function renderEpdDetailPage(id, activeTags = [], activeCategory = '') {
            const data = globalEpdsData.find(item => item.id === id);
            if(!data) {
                contentArea.innerHTML = '<div class="container error-state">Ökobilanzdaten nicht gefunden.</div>';
                return;
            }

            const backLink = buildHashWithTags('epds', activeTags, activeCategory, [], getActiveViewFromURL());

            contentArea.innerHTML = `
                <section class="detail-hero">
                    <div class="container detail-hero__inner">
                        <div class="hero-content">
                            <div class="breadcrumb"><a href="#${backLink}"><i data-lucide="arrow-left" style="vertical-align: text-bottom; margin-right:5px; width: 1.1rem; height: 1.1rem;"></i> Zurück zur Liste</a></div>
                            <h1 class="hero-title">${data.title}</h1>
                            <p class="hero-subtitle">${data.description || 'Ein Ökobilanzdatensatz des KBOB Datenkatalogs.'}</p>
                            <div class="hero-tags">${renderTagsHtml(data.tags, activeTags)}</div>
                        </div>
                        <div class="hero-image-container">
                            ${data.image ? `<img src="${data.image}" alt="${data.title}">` : '<i data-lucide="leaf" class="hero-image-placeholder icon--4xl"></i>'}
                        </div>
                    </div>
                </section>
                <div class="container">
                    <div class="info-box info-box--centered">
                        <i data-lucide="hard-hat" class="info-box__icon icon--4xl"></i>
                        <h2 class="info-box__title">In Entwicklung</h2>
                        <p class="info-box__text">Die Detail-Ansicht für Ökobilanzdaten wird derzeit entwickelt.</p>
                    </div>
                </div>`;
        }

        function setupDetailInteractions() {
             document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const element = document.getElementById(targetId);
                    if(element) element.scrollIntoView({behavior: 'smooth', block: 'start'});
                });
             });
             
             setTimeout(() => {
                 const sectionHash = window.location.hash.split('#')[2];
                 if(sectionHash) document.getElementById(sectionHash)?.scrollIntoView({behavior: 'smooth', block: 'start'});
                 
                 const sections = document.querySelectorAll('.detail-section');
                 const navLinks = document.querySelectorAll('.sticky-nav a');
                 
                 const observer = new IntersectionObserver((entries) => {
                     entries.forEach(entry => {
                         if (entry.isIntersecting) {
                             navLinks.forEach(link => {
                                 const target = link.getAttribute('data-target');
                                 link.classList.toggle('active', target === entry.target.id);
                             });
                         }
                     });
                 }, { threshold: 0.2, rootMargin: "-10% 0px -70% 0px" });
                 
                 sections.forEach(section => observer.observe(section));
             }, 100);
        }

        // Language Dropdown
        function initLanguageDropdown() {
            const dropdown = document.getElementById('langDropdown');
            if (!dropdown) return;

            const toggle = dropdown.querySelector('.lang-dropdown__toggle');
            const menu = dropdown.querySelector('.lang-dropdown__menu');
            const items = dropdown.querySelectorAll('.lang-dropdown__item');
            const currentLang = document.getElementById('currentLang');

            // Toggle dropdown
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = dropdown.classList.toggle('open');
                toggle.setAttribute('aria-expanded', isOpen);
            });

            // Select language
            items.forEach(item => {
                item.addEventListener('click', () => {
                    const lang = item.dataset.lang;

                    // Update active state
                    items.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update button text
                    currentLang.textContent = lang.toUpperCase();

                    // Close dropdown
                    dropdown.classList.remove('open');
                    toggle.setAttribute('aria-expanded', 'false');

                    console.log('Language selected:', lang);
                });
            });

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('open');
                    toggle.setAttribute('aria-expanded', 'false');
                }
            });

            // Keyboard support
            toggle.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('open');
                    toggle.setAttribute('aria-expanded', 'false');
                }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons for loading state
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            initLanguageDropdown();
            initApp();
        });
    </script>
</body>
</html>
